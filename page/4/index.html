
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>LittleQ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="LittleQ">
    

    
    <meta name="description" content="数据开发工程师的成长历程">
<meta property="og:type" content="website">
<meta property="og:title" content="LittleQ">
<meta property="og:url" content="http://sjq597.github.io/page/4/index.html">
<meta property="og:site_name" content="LittleQ">
<meta property="og:description" content="数据开发工程师的成长历程">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LittleQ">
<meta name="twitter:description" content="数据开发工程师的成长历程">

    
    <link rel="alternative" href="/atom.xml" title="LittleQ" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="LittleQ" title="LittleQ"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="LittleQ">LittleQ</a></h1>
				<h2 class="blog-motto">爱好：写代码</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:sjq597.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/26/Linux端口被占用解决方案/" title="Linux端口被占用解决方案" itemprop="url">Linux端口被占用解决方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-06-26T02:52:53.000Z" itemprop="datePublished"> 发表于 2016-06-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>之前一直使用ss代理上google，但是最近不知道怎么回事儿，本地运行<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sslocal -c /etc/<span class="built_in">config</span>.json</div></pre></td></tr></table></figure></p>
<p>报错:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">INFO:</span> loading config from doc/config.json</div><div class="line"><span class="number">2016</span>-<span class="number">06</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">34</span>:<span class="number">53</span> INFO     loading libcrypto from libcrypto.so<span class="meta">.1</span><span class="meta">.0</span><span class="meta">.0</span></div><div class="line"><span class="number">2016</span>-<span class="number">06</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">34</span>:<span class="number">53</span> INFO     starting local <span class="meta">at</span> <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">1080</span></div><div class="line"><span class="number">2016</span>-<span class="number">06</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">34</span>:<span class="number">53</span> ERROR    [Errno <span class="number">98</span>] Address already <span class="keyword">in</span> use</div></pre></td></tr></table></figure></p>
<p>主要是找不到占用这个端口的进程，也不知道怎么把占用端口的进程杀掉,网上查了相关解决方法，总算找到解决方案:<br>首先得找到是哪个进程占用了这个端口,即找出进程的pid:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  ~ netstat -anp | grep <span class="number">1080</span>             </div><div class="line">（并非所有进程都能被检测到，所有非本用户的进程信息将不会显示，如果想看到所有信息，则必须切换到 root 用户）</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">1080</span>            <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">1955</span>/EmbedThunderMa</div></pre></td></tr></table></figure></p>
<p>看到没，那个<code>1955</code>就是罪魁祸首,于是再通过pid查看具体是哪个进程:<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  ~ ps -ef | grep <span class="number">1955</span></div><div class="line">anonymo+  <span class="number">1955</span>  <span class="number">1871</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">47</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">18</span> /opt/xware-desktop/xware/<span class="class"><span class="keyword">lib</span>/<span class="title">EmbedThunderManager</span> *********</span></div><div class="line">anonymo+  <span class="number">5621</span>  <span class="number">2847</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">41</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep --color=auto <span class="number">1955</span></div></pre></td></tr></table></figure></p>
<p>终于找到原因,原来是前一阵子为了下东西，装了一个Linux版的迅雷，虽然最后还是没法下载，但是这东西有个服务开机自动启动，占用了我的1080端口，导致我想用没法用<br>果断卸载了坑爹的迅雷,然后把这个进程杀了<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo kill <span class="number">-9</span> <span class="number">1955</span></div></pre></td></tr></table></figure></p>
<p>然后果然1080端口可以用了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux使用/">Linux使用</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/开发环境/">开发环境</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/21/Spark-下载与入门/" title="Spark 下载与入门" itemprop="url">Spark 下载与入门</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-06-21T15:03:39.000Z" itemprop="datePublished"> 发表于 2016-06-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>开发环境:<br>OS: Ubuntu 16.04 64bit</p>
<h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><h4 id="下载解压"><a href="#下载解压" class="headerlink" title="下载解压"></a>下载解压</h4><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo wget http://d3kbcqa49mib13.cloudfront.net/spark-<span class="number">1.6</span><span class="meta">.1</span>-bin-hadoop2<span class="meta">.6</span>.tgz</div><div class="line">sudo tar -xvf spark-<span class="number">1.6</span><span class="meta">.1</span>-bin-hadoop2<span class="meta">.6</span>.tgz -C /usr/dev </div><div class="line">sudo chown -R anonymous:anonymous spark-<span class="number">1.6</span><span class="meta">.1</span>-bin-hadoop2<span class="meta">.6</span>	# anonymous为当前用户名</div></pre></td></tr></table></figure>
<h4 id="运行Spark"><a href="#运行Spark" class="headerlink" title="运行Spark"></a>运行Spark</h4><p>Spark支持多种语言,我们可以通过Python,Scala进入Spark交互式环境。</p>
<ul>
<li>Scala Shell</li>
</ul>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/dev/spark-1.6.1-bin-hadoop2.6</div><div class="line">./bin/spark-<span class="keyword">shell</span>	# 启动<span class="keyword">Scala</span> <span class="keyword">Shell</span></div></pre></td></tr></table></figure>
<p><strong>注意:</strong>如果报错:<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Tue Jun 21 23:30:04 CST 2016 Thread[main,5,main] java.io.FileNotFoundException: derby.log (权限不够)</div><div class="line">16/06/21 23:30:04 WARN Connection: BoneCP specified but not present in CLASSPATH (or one of dependencies)</div><div class="line">Tue Jun 21 23:30:04 CST 2016 Thread[main,5,main] Cleanup action starting</div><div class="line"><span class="keyword">ERROR </span>XBM0H: Directory /usr/dev/spark<span class="string">-1</span>.6.1-bin-hadoop2.6/bin/metastore_db cannot be created.</div></pre></td></tr></table></figure></p>
<p>出现这个问题一般就是没有创建文件的权限,安装的最后一个命令就是起这个作用的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">chown</span> <span class="selector-tag">-R</span> <span class="selector-tag">anonymous</span><span class="selector-pseudo">:anonymous</span> <span class="selector-tag">spark-1</span><span class="selector-class">.6</span><span class="selector-class">.1-bin-hadoop2</span><span class="selector-class">.6</span>	# <span class="selector-tag">anonymous</span>为当前用户名</div></pre></td></tr></table></figure></p>
<ul>
<li>Python Shell</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/bin/</span>pyspark</div></pre></td></tr></table></figure>
<p>为了在Shell里面写Python有补全提示，强烈建议安装<code>ipython</code>,Ubuntu安装也很简单<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt <span class="keyword">install</span> -y ipython</div></pre></td></tr></table></figure></p>
<p>然后启动的时候可以这样:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">IPYTHON</span>=<span class="number">1</span> ./bin/pyspark</div></pre></td></tr></table></figure></p>
<p>进入Shell大概是这样的:<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">➜  spark-<span class="number">1.6</span>.1-bin-hadoop2.6 IPYTHON=<span class="number">1</span> bin/pyspark</div><div class="line">Python <span class="number">2.7</span>.11+ (default, Apr <span class="number">17</span> <span class="number">2016</span>, <span class="number">14</span>:<span class="number">00</span>:<span class="number">29</span>) </div><div class="line">Type <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</div><div class="line"></div><div class="line">IPython <span class="number">2.4</span>.1 -- An enhanced Interactive Python.</div><div class="line">?         -&gt; Introduction <span class="keyword">and</span> overview of IPython's <span class="built_in">features</span>.</div><div class="line">%quickref -&gt; Quick reference.</div><div class="line">help      -&gt; Python's own help <span class="built_in">system</span>.</div><div class="line">object?   -&gt; Details about 'object', use 'object??' <span class="keyword">for</span> extra details.</div><div class="line">Using Spark's default log4j profile: org/apache/spark/log4j-defaults.<span class="built_in">properties</span></div><div class="line"><span class="number">16</span>/<span class="number">06</span>/<span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">06</span> INFO SparkContext: Running Spark version <span class="number">1.6</span>.1</div><div class="line"><span class="number">16</span>/<span class="number">06</span>/<span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">06</span> WARN NativeCodeLoader: Unable to <span class="built_in">load</span> native-hadoop library <span class="keyword">for</span> your platform... using builtin-java classes where applicable</div><div class="line">Welcome to</div><div class="line">      ____              <span class="symbol">__</span></div><div class="line">     / <span class="symbol">__</span>/<span class="symbol">__</span>  ___ _____/ /<span class="symbol">__</span></div><div class="line">    <span class="symbol">_</span>\ \/ <span class="symbol">_</span> \/ <span class="symbol">_</span> `/ <span class="symbol">__</span>/  '<span class="symbol">_</span>/</div><div class="line">   /<span class="symbol">__</span> / .<span class="symbol">__</span>/\<span class="symbol">_</span>,<span class="symbol">_</span>/<span class="symbol">_</span>/ /<span class="symbol">_</span>/\<span class="symbol">_</span>\   version <span class="number">1.6</span>.1</div><div class="line">      /<span class="symbol">_</span>/</div><div class="line"></div><div class="line">Using Python version <span class="number">2.7</span>.11+ (default, Apr <span class="number">17</span> <span class="number">2016</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">29</span>)</div><div class="line">SparkContext available as sc, HiveContext available as sqlContext.</div><div class="line"></div><div class="line">In [<span class="number">1</span>]: lines = sc.textFile(<span class="string">"README.md"</span>)</div></pre></td></tr></table></figure></p>
<p>如果你觉得这样也有些麻烦,可以在<code>~/.bashrc</code>里面加一行:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">alias</span> ipython=<span class="string">'IPYTHON=1'</span></div></pre></td></tr></table></figure></p>
<p>然后就可以这么启动:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  ~ cd /usr/dev/spark<span class="number">-1.6</span><span class="number">.1</span>-bin-hadoop2<span class="number">.6</span> </div><div class="line">➜  spark<span class="number">-1.6</span><span class="number">.1</span>-bin-hadoop2<span class="number">.6</span> ipython bin/pyspark</div></pre></td></tr></table></figure></p>
<h4 id="简单样例"><a href="#简单样例" class="headerlink" title="简单样例"></a>简单样例</h4><p>Scala也不熟，就以Python为例吧,注意我的当前目录是在<code>/usr/dev/spark-1.6.1-bin-hadoop2.6</code>:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: lines = sc.textFile(<span class="string">"README.md"</span>)</div><div class="line"> n [<span class="number">2</span>]: lines.count()</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">FileInputFormat:</span> Total input paths to <span class="string">process :</span> <span class="number">1</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">SparkContext:</span> Starting <span class="string">job:</span> count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">DAGScheduler:</span> Got job <span class="number">0</span> (count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span>) with <span class="number">2</span> output partitions</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">DAGScheduler:</span> Final <span class="string">stage:</span> ResultStage <span class="number">0</span> (count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">DAGScheduler:</span> Parents of <span class="keyword">final</span> <span class="string">stage:</span> List()</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">DAGScheduler:</span> Missing <span class="string">parents:</span> List()</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">DAGScheduler:</span> Submitting ResultStage <span class="number">0</span> (PythonRDD[<span class="number">2</span>] at count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span>), which has no missing parents</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">MemoryStore:</span> Block broadcast_1 stored <span class="keyword">as</span> values <span class="keyword">in</span> memory (estimated size <span class="number">5.6</span> KB, free <span class="number">173.1</span> KB)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">MemoryStore:</span> Block broadcast_1_piece0 stored <span class="keyword">as</span> bytes <span class="keyword">in</span> memory (estimated size <span class="number">3.4</span> KB, free <span class="number">176.6</span> KB)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">BlockManagerInfo:</span> Added broadcast_1_piece0 <span class="keyword">in</span> memory on <span class="string">localhost:</span><span class="number">36609</span> (<span class="string">size:</span> <span class="number">3.4</span> KB, <span class="string">free:</span> <span class="number">511.5</span> MB)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">SparkContext:</span> Created broadcast <span class="number">1</span> from broadcast at DAGScheduler.<span class="string">scala:</span><span class="number">1006</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">DAGScheduler:</span> Submitting <span class="number">2</span> missing tasks from ResultStage <span class="number">0</span> (PythonRDD[<span class="number">2</span>] at count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">TaskSchedulerImpl:</span> Adding task set <span class="number">0.0</span> with <span class="number">2</span> tasks</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">TaskSetManager:</span> Starting task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">0</span>, localhost, partition <span class="number">0</span>,PROCESS_LOCAL, <span class="number">2151</span> bytes)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">TaskSetManager:</span> Starting task <span class="number">1.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">1</span>, localhost, partition <span class="number">1</span>,PROCESS_LOCAL, <span class="number">2151</span> bytes)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">Executor:</span> Running task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">0</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">Executor:</span> Running task <span class="number">1.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">1</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">HadoopRDD:</span> Input <span class="string">split:</span> <span class="string">file:</span><span class="regexp">/usr/</span>dev<span class="regexp">/spark-1.6.1-bin-hadoop2.6/</span>README.<span class="string">md:</span><span class="number">0</span>+<span class="number">1679</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">HadoopRDD:</span> Input <span class="string">split:</span> <span class="string">file:</span><span class="regexp">/usr/</span>dev<span class="regexp">/spark-1.6.1-bin-hadoop2.6/</span>README.<span class="string">md:</span><span class="number">1679</span>+<span class="number">1680</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">deprecation:</span> mapred.tip.id is deprecated. Instead, use mapreduce.task.id</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">deprecation:</span> mapred.task.id is deprecated. Instead, use mapreduce.task.attempt.id</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">deprecation:</span> mapred.task.is.map is deprecated. Instead, use mapreduce.task.ismap</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">deprecation:</span> mapred.task.partition is deprecated. Instead, use mapreduce.task.partition</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">41</span> INFO <span class="string">deprecation:</span> mapred.job.id is deprecated. Instead, use mapreduce.job.id</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">PythonRunner:</span> <span class="string">Times:</span> total = <span class="number">283</span>, boot = <span class="number">268</span>, init = <span class="number">14</span>, finish = <span class="number">1</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">PythonRunner:</span> <span class="string">Times:</span> total = <span class="number">291</span>, boot = <span class="number">272</span>, init = <span class="number">19</span>, finish = <span class="number">0</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">Executor:</span> Finished task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">0</span>). <span class="number">2124</span> bytes result sent to driver</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">Executor:</span> Finished task <span class="number">1.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">1</span>). <span class="number">2124</span> bytes result sent to driver</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">TaskSetManager:</span> Finished task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">0</span>) <span class="keyword">in</span> <span class="number">407</span> ms on localhost (<span class="number">1</span>/<span class="number">2</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">TaskSetManager:</span> Finished task <span class="number">1.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">1</span>) <span class="keyword">in</span> <span class="number">393</span> ms on localhost (<span class="number">2</span>/<span class="number">2</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">DAGScheduler:</span> ResultStage <span class="number">0</span> (count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span>) finished <span class="keyword">in</span> <span class="number">0.423</span> s</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">TaskSchedulerImpl:</span> Removed TaskSet <span class="number">0.0</span>, whose tasks have all completed, from pool </div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">42</span> INFO <span class="string">DAGScheduler:</span> Job <span class="number">0</span> <span class="string">finished:</span> count at &lt;ipython-input<span class="number">-2</span><span class="number">-44</span>aeefde846d&gt;:<span class="number">1</span>, took <span class="number">0.489031</span> s</div><div class="line">Out[<span class="number">2</span>]: <span class="number">95</span></div><div class="line"></div><div class="line">In [<span class="number">3</span>]: lines.first()</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">SparkContext:</span> Starting <span class="string">job:</span> runJob at PythonRDD.<span class="string">scala:</span><span class="number">393</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Got job <span class="number">1</span> (runJob at PythonRDD.<span class="string">scala:</span><span class="number">393</span>) with <span class="number">1</span> output partitions</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Final <span class="string">stage:</span> ResultStage <span class="number">1</span> (runJob at PythonRDD.<span class="string">scala:</span><span class="number">393</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Parents of <span class="keyword">final</span> <span class="string">stage:</span> List()</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Missing <span class="string">parents:</span> List()</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Submitting ResultStage <span class="number">1</span> (PythonRDD[<span class="number">3</span>] at RDD at PythonRDD.<span class="string">scala:</span><span class="number">43</span>), which has no missing parents</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">MemoryStore:</span> Block broadcast_2 stored <span class="keyword">as</span> values <span class="keyword">in</span> memory (estimated size <span class="number">4.8</span> KB, free <span class="number">181.3</span> KB)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">MemoryStore:</span> Block broadcast_2_piece0 stored <span class="keyword">as</span> bytes <span class="keyword">in</span> memory (estimated size <span class="number">3.0</span> KB, free <span class="number">184.3</span> KB)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">BlockManagerInfo:</span> Added broadcast_2_piece0 <span class="keyword">in</span> memory on <span class="string">localhost:</span><span class="number">36609</span> (<span class="string">size:</span> <span class="number">3.0</span> KB, <span class="string">free:</span> <span class="number">511.5</span> MB)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">SparkContext:</span> Created broadcast <span class="number">2</span> from broadcast at DAGScheduler.<span class="string">scala:</span><span class="number">1006</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Submitting <span class="number">1</span> missing tasks from ResultStage <span class="number">1</span> (PythonRDD[<span class="number">3</span>] at RDD at PythonRDD.<span class="string">scala:</span><span class="number">43</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">TaskSchedulerImpl:</span> Adding task set <span class="number">1.0</span> with <span class="number">1</span> tasks</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">TaskSetManager:</span> Starting task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">1.0</span> (TID <span class="number">2</span>, localhost, partition <span class="number">0</span>,PROCESS_LOCAL, <span class="number">2151</span> bytes)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">Executor:</span> Running task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">1.0</span> (TID <span class="number">2</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">HadoopRDD:</span> Input <span class="string">split:</span> <span class="string">file:</span><span class="regexp">/usr/</span>dev<span class="regexp">/spark-1.6.1-bin-hadoop2.6/</span>README.<span class="string">md:</span><span class="number">0</span>+<span class="number">1679</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">PythonRunner:</span> <span class="string">Times:</span> total = <span class="number">41</span>, boot = <span class="number">-33244</span>, init = <span class="number">33285</span>, finish = <span class="number">0</span></div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">Executor:</span> Finished task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">1.0</span> (TID <span class="number">2</span>). <span class="number">2143</span> bytes result sent to driver</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">TaskSetManager:</span> Finished task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">1.0</span> (TID <span class="number">2</span>) <span class="keyword">in</span> <span class="number">67</span> ms on localhost (<span class="number">1</span>/<span class="number">1</span>)</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> ResultStage <span class="number">1</span> (runJob at PythonRDD.<span class="string">scala:</span><span class="number">393</span>) finished <span class="keyword">in</span> <span class="number">0.068</span> s</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">TaskSchedulerImpl:</span> Removed TaskSet <span class="number">1.0</span>, whose tasks have all completed, from pool </div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">23</span>:<span class="number">58</span>:<span class="number">15</span> INFO <span class="string">DAGScheduler:</span> Job <span class="number">1</span> <span class="string">finished:</span> runJob at PythonRDD.<span class="string">scala:</span><span class="number">393</span>, took <span class="number">0.082887</span> s</div><div class="line">Out[<span class="number">3</span>]: u<span class="string">'# Apache Spark'</span></div></pre></td></tr></table></figure></p>
<p>看看，其实很简单的，但是有个问题，每次输入一个操作，结果搞出这么一大堆的日志，看着确实影响输入，我们可以控制一下Spark的输出日志级别,编辑<code>spark-1.6.1-bin-hadoop2.6/conf/log4j.properties.template</code>文件,为了安全起见，我们直接拷贝一份模板作为我们的日志配置文件:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> conf/</div><div class="line">sudo cp <span class="built_in">log</span>4j.properties.template <span class="built_in">log</span>4j.properties</div></pre></td></tr></table></figure></p>
<p>定位到这一行:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootCategory=INFO, console</div></pre></td></tr></table></figure></p>
<p>改为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>4j.rootCategory=WARN, console</div></pre></td></tr></table></figure></p>
<p>看看之前的操作:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Using Python version <span class="number">2.7</span><span class="number">.11</span>+ (default, Apr <span class="number">17</span> <span class="number">2016</span> <span class="number">14</span>:<span class="number">00</span>:<span class="number">29</span>)</div><div class="line">SparkContext available <span class="keyword">as</span> sc, HiveContext available <span class="keyword">as</span> sqlContext.</div><div class="line"></div><div class="line">In [<span class="number">1</span>]: lines = sc.textFile(<span class="string">"README.md"</span>)</div><div class="line"></div><div class="line">In [<span class="number">2</span>]: lines.count()</div><div class="line">Out[<span class="number">2</span>]: <span class="number">95</span></div><div class="line"></div><div class="line">In [<span class="number">3</span>]: lines.first()</div><div class="line">Out[<span class="number">3</span>]: <span class="string">u'# Apache Spark'</span></div><div class="line"></div><div class="line">In [<span class="number">4</span>]:</div></pre></td></tr></table></figure></p>
<p>这样就只会输出警告及以上的日志了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/大数据/">大数据</a><a href="/tags/开发环境/">开发环境</a><a href="/tags/Spark/">Spark</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/19/CentOS-安装Anaconda2-4-0-0-Linux-x86-64-sh报错/" title="CentOS 安装Anaconda2-4.0.0-Linux-x86_64.sh报错" itemprop="url">CentOS 安装Anaconda2-4.0.0-Linux-x86_64.sh报错</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T11:21:47.000Z" itemprop="datePublished"> 发表于 2016-06-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>前阵子想给服务器都装上Python的全家桶，结果怎么也装不上,开始安装<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">bash</span> <span class="selector-tag">Anaconda2-4</span><span class="selector-class">.0</span><span class="selector-class">.0-Linux-x86_64</span><span class="selector-class">.sh</span></div></pre></td></tr></table></figure></p>
<p>但是装不了，一直报错:<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir: cannot create directory `/home/q/anaconda2': Permission denied</div><div class="line"><span class="keyword">ERROR: </span>Could not create directory: /home/q/anaconda2</div></pre></td></tr></table></figure></p>
<p>网上查了之后发现很多人都碰到这个问题,后来大家都建议这么安装:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">bash</span> <span class="selector-tag">Anaconda2-4</span><span class="selector-class">.0</span><span class="selector-class">.0-Linux-x86_64</span><span class="selector-class">.sh</span></div></pre></td></tr></table></figure></p>
<p>结果报错：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Sorry, user xxx is<span class="built_in"> not </span>allowed to<span class="built_in"> execute </span>'/bin/bash Anaconda2-4.0.0-Linux-x86_64.sh' as root on xxxx.</div></pre></td></tr></table></figure></p>
<p>我去，简直无解了，没权限执行这个命令，普通的命令又装不了，结果折腾了好久也没办法，后来通过求助之后才发现，原来给这个包附个权限就可以执行了，原来如此,说干就干:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo chmod <span class="number">777</span> Anaconda2<span class="number">-4.0</span><span class="number">.0</span>-Linux-x86_64.sh</div><div class="line">sudo ./Anaconda2<span class="number">-4.0</span><span class="number">.0</span>-Linux-x86_64.sh</div></pre></td></tr></table></figure></p>
<p>后面一路畅通，搞定。</p>
<p><strong>Tips:</strong>如果想用这个代替默认的环境变量，有些包这里又没有，假设你的安装目录为<code>/home/usr/anaconda2</code>,那么你可以这么装:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo <span class="meta-keyword">/home/</span>usr<span class="meta-keyword">/anaconda2/</span>bin/pip install <span class="params">&lt;module_name&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Python/">Python</a><a href="/tags/开发工具/">开发工具</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/18/Python-多线程/" title="Python 多线程" itemprop="url">Python 多线程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-06-18T11:23:09.000Z" itemprop="datePublished"> 发表于 2016-06-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="全局解释器锁"><a href="#全局解释器锁" class="headerlink" title="全局解释器锁"></a>全局解释器锁</h3><p>谈到Python多线程,不得不先说一下全局解释器锁(GIL),Python代码的执行由Python虚拟机(也叫解释器主循环)来控制,虽然有多个进程,但是某一个时刻只会有一个线程在执行,对Python虚拟机的访问由全局解释器锁(global interpreter lock,GIL)来控制,正是由于有GIL,同一时刻只会有一个线程在运行,具体的执行步骤为:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">1. </span>设置GIL</div><div class="line"><span class="bullet">2. </span>切换到一个线程去运行</div><div class="line"><span class="bullet">3. </span>运行</div><div class="line">   a. 运行指定字节码的指令,或者</div><div class="line">   b. 线程主动让出控制</div><div class="line"><span class="bullet">4. </span>把线程设置为睡眠状态</div><div class="line"><span class="bullet">5. </span>解锁GIL</div><div class="line"><span class="bullet">6. </span>重复以上所有步骤</div></pre></td></tr></table></figure></p>
<p>所以在调用外部代码的时候,GIL会被锁定,直到调用函数结束为止，看到这里,你可能会觉得Python程序的效率会非常低,毕竟我们的程序会去访问数据库,外部接口,加载本地文件,如果是这样,那我们的程序基本上无时无刻都是卡在那等着。其实你完全不用担心,所有面向I/O的(即调用内建的操作系统C代码)的程序,GIL会在这个I/O调用之前被释放,这样其他程序是可以在等待I/O的时候执行的。不过如果一个程序并没有很多I/O操作,那他只要运行,就一直占用CPU,多线程只对那些I/O密集的程序更有好处。</p>
<h3 id="threading模块"><a href="#threading模块" class="headerlink" title="threading模块"></a>threading模块</h3><p>其实还有一个模块叫<code>thread</code>,但是这个模块使用特别麻烦,官方不建议使用,其中对于锁的操作特别麻烦,而且还有个很大的问题,一旦主进程退出,不管子线程运行完没有都会被强制结束。所以我也不介绍这个模块怎么用了，我们直接看<code>threading</code>模块的使用。</p>
<h4 id="传入可调用函数"><a href="#传入可调用函数" class="headerlink" title="传入可调用函数"></a>传入可调用函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep, ctime</div><div class="line"></div><div class="line">__author__ = <span class="string">'anonymous'</span></div><div class="line"></div><div class="line">loops = [<span class="number">4</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(n_loop, n_sec)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'开始线程'</span>, n_loop, <span class="string">'于'</span>, ctime()</div><div class="line">    sleep(n_sec)</div><div class="line">    <span class="keyword">print</span> <span class="string">'loop函数'</span>, n_loop, <span class="string">'完成于'</span>, ctime()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'开始主线程：'</span>, ctime()</div><div class="line">    threads = []        <span class="comment"># 一个用于储存线程对象的列表</span></div><div class="line">    n_loops = range(len(loops))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        t = threading.Thread(target=loop, args=(i, loops[i]))   <span class="comment"># 每次循环创建一个Thread的实例</span></div><div class="line">        threads.append(t)   <span class="comment"># 将新创建的对象放到一个列表中</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        threads[i].start()  <span class="comment"># 每次循环运行一个线程</span></div><div class="line"></div><div class="line">    <span class="keyword">or</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        threads[i].join()   <span class="comment"># 等待子线程的完成</span></div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'主线程完成：'</span>, ctime()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>输出结果为:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">开始主线程： <span class="selector-tag">Sat</span> <span class="selector-tag">Jun</span> 18 19<span class="selector-pseudo">:47</span><span class="selector-pseudo">:40</span> 2016</div><div class="line">开始线程 开始线程0 于  <span class="selector-tag">Sat</span> <span class="selector-tag">Jun</span> 18 19<span class="selector-pseudo">:47</span><span class="selector-pseudo">:40</span> 20161</div><div class="line"> 于 <span class="selector-tag">Sat</span> <span class="selector-tag">Jun</span> 18 19<span class="selector-pseudo">:47</span><span class="selector-pseudo">:40</span> 2016</div><div class="line"><span class="selector-tag">loop</span>函数 1 完成于 <span class="selector-tag">Sat</span> <span class="selector-tag">Jun</span> 18 19<span class="selector-pseudo">:47</span><span class="selector-pseudo">:42</span> 2016</div><div class="line"><span class="selector-tag">loop</span>函数 0 完成于 <span class="selector-tag">Sat</span> <span class="selector-tag">Jun</span> 18 19<span class="selector-pseudo">:47</span><span class="selector-pseudo">:44</span> 2016</div><div class="line">主线程完成： <span class="selector-tag">Sat</span> <span class="selector-tag">Jun</span> 18 19<span class="selector-pseudo">:47</span><span class="selector-pseudo">:44</span> 2016</div><div class="line"></div><div class="line"><span class="selector-tag">Process</span> <span class="selector-tag">finished</span> <span class="selector-tag">with</span> <span class="selector-tag">exit</span> <span class="selector-tag">code</span> 0</div></pre></td></tr></table></figure></p>
<p>一旦调用<code>start()</code>方法被调用的函数就开始执行了,如果你在主函数里面还要做其他操作，并且这个操作与子线程的执行无关，你完全不用调用<code>join()</code>，可以去做其他操作。调用<code>join()</code>会一直等待子线程执行完毕返回然后再执行后面的步骤。<br><strong>注意:</strong>这个输出并不是连串的,因为我的CPU是多核的，所以日志看上去有点儿不太正常。<code>target</code>一个可调用对象，这里我们传入了一个函数;<code>args</code>是一个元祖，均以位置参数的方式传递给被调用对象。</p>
<h4 id="传入可调用类"><a href="#传入可调用类" class="headerlink" title="传入可调用类"></a>传入可调用类</h4><p>我们也可以传入一个可调用类给<code>Thread</code>实例，不过类必须要实现<code>__call()__</code>方法，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep, ctime</div><div class="line"></div><div class="line">__author__ = <span class="string">'anonymous'</span></div><div class="line"></div><div class="line">loops = [<span class="number">4</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(n_loop, n_sec)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'开始线程'</span>, n_loop, <span class="string">'于'</span>, ctime()</div><div class="line">    sleep(n_sec)</div><div class="line">    <span class="keyword">print</span> <span class="string">'loop函数'</span>, n_loop, <span class="string">'完成于'</span>, ctime()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadFunc</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, args)</span>:</span></div><div class="line">        self.func = func</div><div class="line">        self.args = args</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span>  <span class="comment"># 关键是要实现这个方法</span></div><div class="line">        apply(self.func, self.args)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'开始主线程：'</span>, ctime()</div><div class="line">    threads = []  <span class="comment"># 一个用于储存线程对象的列表</span></div><div class="line">    n_loops = range(len(loops))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        t = threading.Thread(target=ThreadFunc(func=loop, args=(i, loops[i])), )  <span class="comment"># 每次循环创建一个Thread的实例，目标是一个类</span></div><div class="line">        threads.append(t)  <span class="comment"># 将新创建的对象放到一个列表中</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        threads[i].start()  <span class="comment"># 每次循环运行一个线程</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        threads[i].join()  <span class="comment"># 等待子线程的完成</span></div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'主线程完成：'</span>, ctime()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<p>函数的执行结果和上面是一样的，这里我就不再贴运行结果了。</p>
<h4 id="创建Thread子类"><a href="#创建Thread子类" class="headerlink" title="创建Thread子类"></a>创建Thread子类</h4><p>这种方式比较灵活，更加通用，只用在内部冲洗run方法即可<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep, ctime</div><div class="line"></div><div class="line">__author__ = <span class="string">'anonymous'</span></div><div class="line"></div><div class="line">loops = [<span class="number">4</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(n_loop, n_sec)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'开始线程'</span>, n_loop, <span class="string">'于'</span>, ctime()</div><div class="line">    sleep(n_sec)</div><div class="line">    <span class="keyword">print</span> <span class="string">'loop函数'</span>, n_loop, <span class="string">'完成于'</span>, ctime()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, args)</span>:</span></div><div class="line">        threading.Thread.__init__(self)  <span class="comment"># 调用父类的构造函数</span></div><div class="line">        self.func = func</div><div class="line">        self.args = args</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        apply(self.func, self.args)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'开始主线程：'</span>, ctime()</div><div class="line">    threads = []  <span class="comment"># 一个用于储存线程对象的列表</span></div><div class="line">    n_loops = range(len(loops))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        t = MyThread(func=loop, args=(i, loops[i]))  <span class="comment"># 使用我们自己的类来新建对象</span></div><div class="line">        threads.append(t)  <span class="comment"># 将新创建的对象放到一个列表中</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        threads[i].start()  <span class="comment"># 每次循环运行一个线程</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n_loops:</div><div class="line">        threads[i].join()  <span class="comment"># 等待子线程的完成</span></div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'主线程完成：'</span>, ctime()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<p>调用子类<code>MyThread</code>的<code>start()</code>方法即可，同样<code>join()</code>用于等待自线程执行完。这种方式相比上面的两种方式好处在哪？想象一下，我们的函数执行如果返回的是一个二维数组，如果仅仅有<code>start(),join()</code>这样的方法，我们怎么获取最后我们执行的返回值呢？如果是子类，我们完全可以在调用<code>run()</code>方法里面把这个结果保存下来，然后最后调用子类的实例去获取这个变量就行了,像下面这样:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">import threading</div><div class="line">from time import sleep, ctime</div><div class="line"></div><div class="line">__author_<span class="number">_</span> = <span class="string">'anonymous'</span></div><div class="line"></div><div class="line">loops = [<span class="number">4</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(n_loop, n_sec)</span></span>:</div><div class="line">    <span class="keyword">return</span> n_loop + n_sec  <span class="comment"># 返回两个参数的和</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span>(<span class="title">threading</span>.<span class="title">Thread</span>):</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, func, args)</span></span>:</div><div class="line">        threading.Thread.__init_<span class="number">_</span>(<span class="keyword">self</span>)  <span class="comment"># 调用父类的构造函数</span></div><div class="line">        <span class="keyword">self</span>.func = func</div><div class="line">        <span class="keyword">self</span>.args = args</div><div class="line">        <span class="keyword">self</span>.result = None</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">        <span class="keyword">self</span>.result = apply(<span class="keyword">self</span>.func, <span class="keyword">self</span>.args)  <span class="comment"># 调用函数的结果作为一个属性</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span></span>:</div><div class="line">    print <span class="string">'开始主线程：'</span>, ctime()</div><div class="line">    threads = []  <span class="comment"># 一个用于储存线程对象的列表</span></div><div class="line">    n_loops = range(len(loops))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="symbol">n_loops:</span></div><div class="line">        t = MyThread(func=loop, args=(i, loops[i]))  <span class="comment"># 使用我们自己的类来新建对象</span></div><div class="line">        threads.append(t)  <span class="comment"># 将新创建的对象放到一个列表中</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="symbol">n_loops:</span></div><div class="line">        threads[i].start()  <span class="comment"># 每次循环运行一个线程</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="symbol">n_loops:</span></div><div class="line">        threads[i].join()  <span class="comment"># 等待子线程的完成</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="symbol">n_loops:</span></div><div class="line">        print <span class="string">'执行结果为：'</span>, threads[i].result  <span class="comment"># 打印该对象的属性</span></div><div class="line"></div><div class="line">    print <span class="string">'主线程完成：'</span>, ctime()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<p>执行结果为:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">开始主线程： Sat Jun <span class="number">18</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">51</span> <span class="number">2016</span></div><div class="line">执行结果为： <span class="number">4</span></div><div class="line">执行结果为： <span class="number">3</span></div><div class="line">主线程完成： Sat Jun <span class="number">18</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">51</span> <span class="number">2016</span></div><div class="line"></div><div class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></div></pre></td></tr></table></figure></p>
<h3 id="Python进程池"><a href="#Python进程池" class="headerlink" title="Python进程池"></a>Python进程池</h3><p>实际在项目中，我们可能会碰到这样的问题，有一个MySQL的表分库分表了，总数大概有1000张，我们想看看每天的数据量有多大，由于这个是线上的库，我们不能开太多的连接，如果把数据库搞挂了不好，但是一个一个去算又太慢，所以需要控制连接的数量，太大太小都不好，这个时候可以使用进程池，控制并发的数量。</p>
<h4 id="进程池-非阻塞"><a href="#进程池-非阻塞" class="headerlink" title="进程池(非阻塞)"></a>进程池(非阻塞)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line">__author__ = <span class="string">'anonymous'</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> freeze_support, Pool</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Foo</span><span class="params">(i)</span>:</span></div><div class="line">    time.sleep(<span class="number">2</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">'time start:%s'</span> % time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</div><div class="line">    <span class="keyword">return</span> i + <span class="number">100</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Bar</span><span class="params">(arg)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'time  done:%s %s'</span> % (time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>), arg)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    freeze_support()</div><div class="line">    pool = Pool(<span class="number">3</span>)  <span class="comment"># 线程池中的同时执行的进程数为3</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</div><div class="line">        pool.apply_async(func=Foo, args=(i,), callback=Bar)  <span class="comment"># 线程池中的同时执行的进程数为3，当一个进程执行完毕后，如果还有新进程等待执行，则会将其添加进去</span></div><div class="line"></div><div class="line">    print(<span class="string">'end'</span>)</div><div class="line">    pool.close()</div><div class="line">    pool.join()  <span class="comment"># 调用join之前，先调用close函数，否则会出错。执行完close后不会有新的进程加入到pool,join函数等待所有子进程结束</span></div></pre></td></tr></table></figure>
<p>输出结果为:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">end</span></div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:12</span></div><div class="line"><span class="selector-tag">time</span>  <span class="selector-tag">done</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:12</span> 100</div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:12</span></div><div class="line"><span class="selector-tag">time</span>  <span class="selector-tag">done</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:12</span> 101</div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:12</span></div><div class="line"><span class="selector-tag">time</span>  <span class="selector-tag">done</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:12</span> 102</div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:14</span></div><div class="line"><span class="selector-tag">time</span>  <span class="selector-tag">done</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:08</span><span class="selector-pseudo">:14</span> 103</div></pre></td></tr></table></figure></p>
<p>进程池的大小为3，很明显可以看到，前三个函数的开始时间都是一样的，并且都是不等<code>Foo</code>函数执行完就掉用<code>Bar</code>函数</p>
<ul>
<li><code>apply_async(func[, args[, kwds[, callback]]])</code>它是<strong>非阻塞</strong>，<code>apply(func[, args[, kwds]])</code>是<strong>阻塞</strong>的.</li>
<li><code>close()</code>关闭pool,使其不再接受新的任务</li>
<li><code>join()</code> 主进程阻塞，等待子进程退出，必须在<code>close()</code>和<code>terminate()</code>之后调用</li>
</ul>
<h4 id="进程池-阻塞"><a href="#进程池-阻塞" class="headerlink" title="进程池(阻塞)"></a>进程池(阻塞)</h4><p>和上面的代码差不多，只是把对应部分改一下:<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding: utf-<span class="number">8</span> -*-</div><div class="line"></div><div class="line">__author__ = 'anonymous'</div><div class="line"></div><div class="line">from multiprocessing import freeze_support, Pool</div><div class="line">import <span class="built_in">time</span></div><div class="line"></div><div class="line"></div><div class="line">def Foo(i):</div><div class="line">    <span class="built_in">time</span>.sleep(<span class="number">2</span>)</div><div class="line">    <span class="built_in">print</span> '<span class="built_in">time</span> start:<span class="built_in">%s</span>' <span class="symbol">%</span> <span class="built_in">time</span>.strftime('%Y-<span class="built_in">%m</span>-%d %H:%M:%S')</div><div class="line">    <span class="built_in">return</span> i + <span class="number">100</span></div><div class="line"></div><div class="line"></div><div class="line">def Bar(arg):</div><div class="line">    <span class="built_in">print</span> '<span class="built_in">time</span>  done:<span class="built_in">%s</span> <span class="built_in">%s</span>' <span class="symbol">%</span> (<span class="built_in">time</span>.strftime('%Y-<span class="built_in">%m</span>-%d %H:%M:%S'), arg)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == '__main__':</div><div class="line">    freeze_support()</div><div class="line">    pool = Pool(<span class="number">3</span>)  # 线程池中的同时执行的进程数为<span class="number">3</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</div><div class="line">        pool.<span class="built_in">apply</span>(func=Foo, <span class="built_in">args</span>=(i,))</div><div class="line"></div><div class="line">    <span class="built_in">print</span>('end')</div><div class="line">    pool.<span class="built_in">close</span>()</div><div class="line">    pool.<span class="built_in">join</span>()  # 调用<span class="built_in">join</span>之前，先调用<span class="built_in">close</span>函数，否则会出错。执行完<span class="built_in">close</span>后不会有新的进程加入到pool,<span class="built_in">join</span>函数等待所有子进程结束</div></pre></td></tr></table></figure></p>
<p>执行结果如下:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:14</span><span class="selector-pseudo">:00</span></div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:14</span><span class="selector-pseudo">:02</span></div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:14</span><span class="selector-pseudo">:04</span></div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:14</span><span class="selector-pseudo">:06</span></div><div class="line"><span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<h4 id="进程池-关注返回结果"><a href="#进程池-关注返回结果" class="headerlink" title="进程池(关注返回结果)"></a>进程池(关注返回结果)</h4><p>多半情况下我们还是要关注函数的执行返回结果，并不能完全想像上面那样阻塞运行或者非阻塞等函未执行完就调用回调函数:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env <span class="keyword">python</span></div><div class="line"># -*- codin<span class="variable">g:</span> utf-<span class="number">8</span> -*-</div><div class="line">import multiprocess</div><div class="line"></div><div class="line">__author__ = <span class="string">'anonymous'</span></div><div class="line">import time</div><div class="line"></div><div class="line"></div><div class="line">def func(msg):</div><div class="line">    <span class="keyword">print</span> <span class="string">'time start:%s'</span> % time.<span class="built_in">strftime</span>(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</div><div class="line">    time.<span class="keyword">sleep</span>(<span class="number">2</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">'time   end:%s'</span> % time.<span class="built_in">strftime</span>(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</div><div class="line">    <span class="keyword">return</span> <span class="string">'done'</span> + msg</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    pool = multiprocess.Pool(<span class="number">2</span>)</div><div class="line">    result = []</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">3</span>):</div><div class="line">        msg = <span class="string">'hello %s'</span> % i</div><div class="line">        result.<span class="keyword">append</span>(pool.apply_async(func=func, <span class="keyword">args</span>=(msg,)))</div><div class="line"></div><div class="line">    pool.<span class="keyword">close</span>()</div><div class="line">    pool.<span class="keyword">join</span>()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> <span class="keyword">res</span> in resul<span class="variable">t:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'***: %s'</span> % <span class="keyword">res</span>.<span class="built_in">get</span>()</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'end'</span></div></pre></td></tr></table></figure></p>
<p>执行看一下返回结果是啥<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:43</span><span class="selector-pseudo">:22</span></div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:43</span><span class="selector-pseudo">:22</span></div><div class="line"><span class="selector-tag">time</span>   <span class="selector-tag">end</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:43</span><span class="selector-pseudo">:24</span></div><div class="line"><span class="selector-tag">time</span> <span class="selector-tag">start</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:43</span><span class="selector-pseudo">:24</span></div><div class="line"><span class="selector-tag">time</span>   <span class="selector-tag">end</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:43</span><span class="selector-pseudo">:24</span></div><div class="line"><span class="selector-tag">time</span>   <span class="selector-tag">end</span><span class="selector-pseudo">:2016-06-19</span> 18<span class="selector-pseudo">:43</span><span class="selector-pseudo">:26</span></div><div class="line">***: <span class="selector-tag">done</span> <span class="selector-tag">hello</span> 0</div><div class="line">***: <span class="selector-tag">done</span> <span class="selector-tag">hello</span> 1</div><div class="line">***: <span class="selector-tag">done</span> <span class="selector-tag">hello</span> 2</div><div class="line"><span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<p>可以看到，我们可以使用<code>get()</code>方法获取被调用函数的返回值</p>
<h4 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h4><p>还有一种方式，可以使用<code>pool.map()</code>，以我们最开始的例子为例，我们要查询1000张表，可以把参数放在一个可迭代对象里，使用pool.map()找依次多个处理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"></div><div class="line">__author__ = <span class="string">'anonymous'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">m1</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x * x</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    pool = multiprocessing.Pool(multiprocessing.cpu_count())</div><div class="line">    i_list = range(<span class="number">8</span>)</div><div class="line">    result = pool.map(m1, i_list)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> sum(result)</div></pre></td></tr></table></figure></p>
<p>执行结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">140</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Python笔记/">Python笔记</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Python/">Python</a><a href="/tags/多线程/">多线程</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/29/Ubuntu-启动栏应用无法启动解决方案/" title="Ubuntu 启动栏应用无法启动解决方案" itemprop="url">Ubuntu 启动栏应用无法启动解决方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-05-29T11:36:35.000Z" itemprop="datePublished"> 发表于 2016-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近刚装好了Ubuntu16.04，好不容易配置好了开发环境，突然发现IDEA,和PyCharm无法从启动栏和Dash菜单中启动，摸索来一阵之后，查阅资料发现来问题所在,记录一下，也希望给其他人一点参考，简单来说就是，环境变量不对导致无法启动。<br>以IntelliJ IDEA为例，我的IDEA和Pycharm都只能从终端启动，很不方便，即是从终端启动了，我把图标固定在左侧的快速启动栏，仍然启动不了，下面看看解决办法。<br>首先去<code>/usr/share/applications</code>文件夹看看，找到你的程序，双击，如果能够启动则应该没是没有问题的，但是双击不能启动，则即使你把图标固定到快速启动栏，程序仍然启动不了。<br>双击<code>IntelliJ IDEA</code>图标，提示报错信息，找不到JDK,问题就出在这里，但是奇怪的是我明明装了JDK,也设置来环境变量，怎么会找不到呢？于是我用vim查看了一下这个启动项的具体配置:<br><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ cd /usr/share/applications</div><div class="line">$ cat jetbrains-idea.desktop</div><div class="line">[Desktop Entry]</div><div class="line">Version=<span class="number">1.0</span></div><div class="line">Type=Application</div><div class="line">Name=IntelliJ IDEA</div><div class="line">Icon=/usr/dev/idea-IU-<span class="number">139.1117</span>.<span class="number">1</span>/bin/idea.png</div><div class="line">Exec=<span class="string">"/usr/dev/idea-IU-139.1117.1/bin/idea.sh"</span> %f</div><div class="line">Comment=Develop with pleasure!</div><div class="line">Categories=Development;IDE;</div><div class="line">Terminal=<span class="literal">false</span></div><div class="line">StartupWMClass=jetbrains-idea</div></pre></td></tr></table></figure></p>
<p>可以看到启动程序调用的脚本路径<code>/usr/dev/idea-IU-139.1117.1/bin/idea.sh</code>，这个就是我IDEA的解压安装路径，但是奇怪的是我从终端启动也是运行的这个脚本，就可以启动，为什么系统调用就不行呢？而且错误信息提示的是找不到JDK,后来我才明白，原来我安装了zsh,所以设置在<code>~/.zshrc</code>里面的环境变量并不能对bash启动的程序生效，所以找不到JDK。<br>既然明白了问题所在，解决办法也就有了,要么把环境变量设置成系统级别的环境变量，要么直接在对应的启动脚本中加入JDK的路径:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ cat /usr/dev/idea-IU-139.1117.1/bin/idea.sh</div><div class="line"><span class="comment"># ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"># Locate a JDK installation directory which will be used to run the IDE.</span></div><div class="line"><span class="comment"># Try (in order): IDEA_JDK, JDK_HOME, JAVA_HOME, "java" in PATH.</span></div><div class="line"><span class="comment"># ---------------------------------------------------------------------</span></div><div class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$IDEA_JDK</span>"</span> <span class="_">-a</span> -x <span class="string">"<span class="variable">$IDEA_JDK</span>/bin/java"</span> ]; <span class="keyword">then</span></div><div class="line">  JDK=<span class="string">"<span class="variable">$IDEA_JDK</span>"</span></div><div class="line"><span class="keyword">elif</span> [ -n <span class="string">"<span class="variable">$JDK_HOME</span>"</span> <span class="_">-a</span> -x <span class="string">"<span class="variable">$JDK_HOME</span>/bin/java"</span> ]; <span class="keyword">then</span></div><div class="line">  JDK=<span class="string">"<span class="variable">$JDK_HOME</span>"</span></div><div class="line"><span class="keyword">elif</span> [ -n <span class="string">"<span class="variable">$JAVA_HOME</span>"</span> <span class="_">-a</span> -x <span class="string">"<span class="variable">$JAVA_HOME</span>/bin/java"</span> ]; <span class="keyword">then</span></div><div class="line">  JDK=<span class="string">"<span class="variable">$JAVA_HOME</span>"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">  JAVA_BIN_PATH=`<span class="built_in">which</span> java`</div><div class="line">.......</div></pre></td></tr></table></figure></p>
<p>分析启动脚本，反正就是找不到JAVA_HOME,JDK的路径了,简单粗暴的直接在检查变量之前定义好,在注释下面，条件判断的前面加上JAVA的配置<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">JAVA_HOME</span>=/usr/dev/jdk1.<span class="number">7.0</span>_40</div><div class="line"><span class="attr">JRE_HOME</span>=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</div></pre></td></tr></table></figure></p>
<p>这样再点击图标就可以运行了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux使用/">Linux使用</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Shell/">Shell</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/29/Hive-正则/" title="Hive 正则" itemprop="url">Hive 正则</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-05-29T09:53:35.000Z" itemprop="datePublished"> 发表于 2016-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>分析日志经常要用到正则来提取需要分析的关键信息,其中需要注意的就是,Hive本身史用Java写的，所以HQL里面的正则和Java里面史一样的，但是具体在使用的时候，会碰到很多问题，就是转义的问题，总结了一下在各个语言中使用HQL时正则的不同情况。</p>
<h3 id="Hive-Cli"><a href="#Hive-Cli" class="headerlink" title="Hive Cli"></a>Hive Cli</h3><p>平时使用的时候，很多情况下都是在Hive Cli客户端中使用，这里和正常的正则需要稍微有一些区别,例如匹配数字，正常情况下就<code>\d</code>，但是在Hive Cli中需要注意,应该使用<code>\\d</code>。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span></div><div class="line">  regexp_extract(<span class="keyword">content</span>, <span class="string">'.*id=(\\d*).*'</span>, <span class="number">1</span>) <span class="keyword">as</span> <span class="keyword">id</span> </div><div class="line"><span class="keyword">from</span></div><div class="line">  test.table_test;</div></pre></td></tr></table></figure></p>
<h3 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h3><p>还有一种更为常见的使用场景，就是在Shell脚本中使用，Shell脚本中又涉及到单引号和双引号的区别,单引号史强引用类型,<code>\</code>不会被转义，但是双引号字符串则会转义，例如:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">reg_str1=<span class="string">'.*id=(\\d*).*'</span></div><div class="line">reg_str2=<span class="string">".*id=(\\\\d*).*"</span></div><div class="line"></div><div class="line">sudo -uhiev_user /usr/dev/hive-1.2.0/bin/hive <span class="_">-e</span> <span class="string">"</span></div><div class="line">select</div><div class="line">  regexp_extract(content, '<span class="variable">$&#123;reg_str1&#125;</span>', 1) as id1, </div><div class="line">  regexp_extract(content, '<span class="variable">$&#123;reg_str2&#125;</span>', 1) as id2 </div><div class="line">from</div><div class="line">  test.table_test;</div><div class="line">"</div></pre></td></tr></table></figure></p>
<p>这两个正则表达式是一样的，其实确认你的HQL正则表达式是否有用，可以先用echo在sudo前面看看，如果输出的史<code>\\d</code>则说明有用</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>有时候需要在Python中执行HQL,好像Hive并不支持Python接口,所以我采取的是在Python中执行Shel命令<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># bash_cmd为Shell命令</span></div><div class="line">bash_cmd = <span class="string">"""</span></div><div class="line">sudo -uhive_user /usr/dev/hive-1.2.0/bin/hive -e "&#123;0&#125;"</div><div class="line">""".format(sql)	<span class="comment"># sql即为要执行的HQL</span></div><div class="line"></div><div class="line">hql_process = subprocess.Popen(bash_cmd, shell=<span class="keyword">True</span>, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</div></pre></td></tr></table></figure></p>
<p>在Python中我定义来一个sql<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sql = <span class="string">"""</span></div><div class="line">select</div><div class="line">  regexp_extract(content, '.*id=(\\\\\\d*).*', 1) as id </div><div class="line">from</div><div class="line">  test.table_test;</div><div class="line">"""</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Hive笔记/">Hive笔记</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Hive/">Hive</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/30/Flask-学习笔记-02/" title="Flask 学习笔记 02" itemprop="url">Flask 学习笔记 02</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-04-30T06:03:37.000Z" itemprop="datePublished"> 发表于 2016-04-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从简单的例子学习Flask,因为是简单的例子，就用子单的<code>sqlite3</code>数据库了，如果项目大了，数据量大可以考虑使用<code>MySQL</code>。</p>
<h3 id="项目步骤"><a href="#项目步骤" class="headerlink" title="项目步骤"></a>项目步骤</h3><p>一步步来演示一个项目是如何创建的</p>
<ul>
<li>先创建文件夹<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">➜  flasker  tree</div><div class="line">.</div><div class="line">├── <span class="keyword">static</span></div><div class="line">└── templates</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="数据库模式，将下面的内容保存在schema-sql，放在flasker目录下就行"><a href="#数据库模式，将下面的内容保存在schema-sql，放在flasker目录下就行" class="headerlink" title="数据库模式，将下面的内容保存在schema.sql，放在flasker目录下就行:"></a>数据库模式，将下面的内容保存在<code>schema.sql</code>，放在<code>flasker</code>目录下就行:</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> entries;</div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> entries (</div><div class="line">  <span class="keyword">id</span> <span class="built_in">integer</span> primary <span class="keyword">key</span> autoincrement,</div><div class="line">  title <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">  <span class="built_in">text</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span></div><div class="line">);</div></pre></td></tr></table></figure>
<h4 id="应用构建"><a href="#应用构建" class="headerlink" title="应用构建"></a>应用构建</h4><p>创建应用模块，吧模块命名为<code>flaskr.py</code>,就放在flaskr文件夹中，为了方便学习，把库的导入和相关配置放在了一起，但是一个清晰的方案应该是放在一个独立的<code>__init__.py</code>文件中，然后在模块里导入配置，不过这个也有一个不好的地方，就是你在主文件里不知道的包到底是从哪导入的,flaskr.py内容如下:<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># all the imports</span></div><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session, g, redirect, url_for, <span class="string">\</span></div><div class="line">     abort, render_template, flash</div><div class="line"></div><div class="line"><span class="comment"># configuration</span></div><div class="line">DATABASE = <span class="string">'/tmp/r.db'</span></div><div class="line">DEBUG = True</div><div class="line">SECRET_KEY = <span class="string">'development key'</span></div><div class="line">USERNAME = <span class="string">'admin'</span></div><div class="line">PASSWORD = <span class="string">'default'</span></div></pre></td></tr></table></figure></p>
<p>然后在同一个文件中创建真正的应用，使用配置来初始化：<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># create our little application :)</span></div><div class="line">app = Flask(<span class="variable">__name__</span>)</div><div class="line">app.config.from_object(<span class="variable">__name__</span>)</div></pre></td></tr></table></figure></p>
<p><code>from_object</code>的传入参数如果是字符串则直接导入，它会搜索加载多有大写的变量名，就是我们写在最前面的，你也可以把这个写在<code>__init__.py</code>文件中。一般都是总配置文件导入配置的，建议使用<code>from_envvar()</code>来导入配置，上面的第二行可以替换为:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app<span class="selector-class">.config</span><span class="selector-class">.from_envvar</span>(<span class="string">'FLASKR_SETTINGS'</span>, silent=True)</div></pre></td></tr></table></figure></p>
<p>这个可以设置一个<code>FLASKR_SETTINGS</code>变量来指定一个配置文件，并根据该文件来重载缺省配置，<code>silent</code>意思是如果没有，则不报错。<br>然后添加一个用于连接数据库的方法。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect_db</span><span class="params">()</span></span>:</div><div class="line">    <span class="keyword">return</span> sqlite3.connect(app.config[<span class="string">'DATABASE'</span>])</div></pre></td></tr></table></figure></p>
<p>然后在最后以单机模式启动的代码:<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    app.<span class="built_in">run</span>()</div></pre></td></tr></table></figure></p>
<p>这样虽然可以启动服务器，但是无法访问界面，因为没有构建任何视图。</p>
<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>每次去执行命令导入不是很方便，受限于系统，所以添加一个数据库初始化函数，首先要导入<code>contextlib.closing()</code>函数,即:<br><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> closing</div></pre></td></tr></table></figure></p>
<p>然后创建一个初始数据库的函数<code>init_db()</code>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">with</span> closing(connect_db()) <span class="keyword">as</span> db:</div><div class="line">        <span class="keyword">with</span> app.open_resource(<span class="string">'schema.sql'</span>, mode=<span class="string">'r'</span>) <span class="keyword">as</span> f:</div><div class="line">            db.cursor().executescript(f.read())</div><div class="line">        db.commit()</div></pre></td></tr></table></figure></p>
<p><code>closing()</code>函数允许我们在with代码块中保持数据库打开，然后<code>open_resouce()</code>也支持这个功能，直接在with代码块中使用，<code>sqlite3</code>里面的sql都必须显示的提交才会生效。</p>
<h4 id="请求数据库连接"><a href="#请求数据库连接" class="headerlink" title="请求数据库连接"></a>请求数据库连接</h4><p>当然你可以生成一个全局的数据库连接句柄，这样在每个函数里面就可以使用数据库连接了，但是并不推荐这样，会带来很多问题，也不够优雅。Flask里面利用装饰器能够做到优雅的访问数据库，<code>before_request()</code>,<code>after_request()</code>,<code>teardown_request()</code>这三个装饰器就可以满足需求：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.before_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span><span class="params">()</span>:</span></div><div class="line">    g.db = connect_db()</div><div class="line"></div><div class="line"><span class="meta">@app.teardown_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">teardown_request</span><span class="params">(exception)</span>:</span></div><div class="line">    db = getattr(g, <span class="string">'db'</span>, <span class="keyword">None</span>)</div><div class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        db.close()</div><div class="line">    g.db.close()</div></pre></td></tr></table></figure></p>
<p>来看看这段代码是如何的优雅，使用<code>before_request()</code>装饰函数会在请求之前调用，不用传递任何参数，这样在每个视图函数里面都可以通过全局<code>g</code>对象获取数据库连接句柄。使用<code>after_request()</code>会在请求之后调用，并且会传递相应对象给客户端，所以出错了就不会执行。因此需要用到第三个装饰器<code>teardown_request()</code>装饰器，这个装饰器会在响应对象构建完之后才调用被装饰的函数，不允许修改请求，而且返回值也会被忽略，如果出错了，这个错误会传递给每个函数。这里的<code>g</code>对象简单理解就是一个神奇的全局对象，并且多线程也可以正常工作。</p>
<h4 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h4><p>在数据库连接处理完之后，就可以来构造视图了，下面简单介绍一个例子：</p>
<h5 id="显示条目"><a href="#显示条目" class="headerlink" title="显示条目"></a>显示条目</h5><p>这个视图将会显示所有数据库中的连接，模板为<code>show_entries.html</code>,并返回渲染结果:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_entries</span><span class="params">()</span></span>:</div><div class="line">    cur = g.db.execute(<span class="string">'select title, text from entries order by id desc'</span>)</div><div class="line">    entries = [dict(title=row[<span class="number">0</span>], text=row[<span class="number">1</span>]) <span class="keyword">for</span> row <span class="keyword">in</span> cur.fetchall()]</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'show_entries.html'</span>, entries=entries)</div></pre></td></tr></table></figure></p>
<h4 id="添加条目"><a href="#添加条目" class="headerlink" title="添加条目"></a>添加条目</h4><p>添加一条新记录，添加完之后并不会显示，结果显示在<code>show_entries</code>页面中，如果成功，则会flash()一个消息给下一个请求并重定向到<code>show_entries</code>页面：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/add'</span>, methods=[<span class="string">'POST'</span>])</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_entry</span><span class="params">()</span></span>:</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">'logged_in'</span>):</div><div class="line">        abort(<span class="number">401</span>)</div><div class="line">    g.db.execute(<span class="string">'insert into entries (title, text) values (?, ?)'</span>,</div><div class="line">                 [request.form[<span class="string">'title'</span>], request.form[<span class="string">'text'</span>]])</div><div class="line">    g.db.commit()</div><div class="line">    flash(<span class="string">'New entry was successfully posted'</span>)</div><div class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'show_entries'</span>))</div></pre></td></tr></table></figure></p>
<p>这里还有个检查是否登陆的，就是<code>logged_in</code>是否为<code>True</code>。另外一个，为了防止SQL注入，劲量不要拼sql,用<code>?</code>代替。</p>
<h4 id="登陆和注销"><a href="#登陆和注销" class="headerlink" title="登陆和注销"></a>登陆和注销</h4><p>用于登陆和注销，根据配置中的用户名和密码验证用户会话中设置<code>logged_in</code>的键值。如果通过验证，则设置<code>logged_in</code>为True,然后重定向到<code>show_entries</code>页面。另外闪现一个信息，告诉用户已登陆成功，如果出错，则提示错误信息，并重新登陆:<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/login'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</div><div class="line">def login():</div><div class="line">    <span class="keyword">error</span> = None</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        <span class="keyword">if</span> request.form[<span class="string">'username'</span>] != app.config[<span class="string">'USERNAME'</span>]:</div><div class="line">            <span class="keyword">error</span> = <span class="string">'Invalid username'</span></div><div class="line">        elif request.form[<span class="string">'password'</span>] != app.config[<span class="string">'PASSWORD'</span>]:</div><div class="line">            <span class="keyword">error</span> = <span class="string">'Invalid password'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            session[<span class="string">'logged_in'</span>] = True</div><div class="line">            flash(<span class="string">'You were logged in'</span>)</div><div class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'show_entries'</span>))</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, <span class="keyword">error</span>=<span class="keyword">error</span>)</div></pre></td></tr></table></figure></p>
<p>注销视图则会相反，移除键值：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/logout'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span></span>:</div><div class="line">    session.pop(<span class="string">'logged_in'</span>, None)</div><div class="line">    flash(<span class="string">'You were logged out'</span>)</div><div class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'show_entries'</span>))</div></pre></td></tr></table></figure></p>
<p>使用<code>pop()</code>函数如果传递了第二个参数(键的缺省值),如果有的话就会删掉，如果没有，就啥也不做。</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>光有视图还不够，上面用到的模板还没有写好，访问也会报错，然后还用到了模板继承保存所有页面布局统一，这些文件都保存在<code>templates</code>文件夹中:</p>
<h4 id="layout-html"><a href="#layout-html" class="headerlink" title="layout.html"></a>layout.html</h4><p>这个模板包含了HTML的骨架，头部和一个登陆链接(如果用户已登陆则变为一个注销连接)。如果有闪现消息，则也显示出来:<br><figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> body %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure></p>
<p>上面的块儿会被子模块中同名的body替换。而且session在模板中也可以使用，如果键值(属性)不存在也可以正常运行：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!doctype html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">stylesheet</span> <span class="attr">type</span>=<span class="string">text/css</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for('static', filename='style.css') &#125;&#125;"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">page</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">metanav</span>&gt;</span></div><div class="line">  &#123;% if not session.logged_in %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for('login') &#125;&#125;"</span>&gt;</span>log in<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  &#123;% else %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for('logout') &#125;&#125;"</span>&gt;</span>log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  &#123;% endif %&#125;</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  &#123;% for message in get_flashed_messages() %&#125;</div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">flash</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  &#123;% endfor %&#125;</div><div class="line">  &#123;% block body %&#125;&#123;% endblock %&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="show-entries-html"><a href="#show-entries-html" class="headerlink" title="show_entries.html"></a>show_entries.html</h4><figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> "layout.html" %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> body %&#125;</span><span class="xml"></span></div><div class="line">  <span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> session.logged_in %&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; url_for('add_entry') &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">method</span>=<span class="string">post</span> <span class="attr">class</span>=<span class="string">add-entry</span>&gt;</span></span></div><div class="line">      <span class="tag">&lt;<span class="name">dl</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Title:</div><div class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">size</span>=<span class="string">30</span> <span class="attr">name</span>=<span class="string">title</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Text:</div><div class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">text</span> <span class="attr">rows</span>=<span class="string">5</span> <span class="attr">cols</span>=<span class="string">40</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">Share</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">  <span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">entries</span>&gt;</span></div><div class="line">  <span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> entry <span class="keyword">in</span> entries %&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="template-variable">&#123;&#123; entry.title &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><span class="template-variable">&#123;&#123; entry.text|<span class="name">safe</span> &#125;&#125;</span><span class="xml"></span></div><div class="line">  <span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Unbelievable.  No entries here so far<span class="tag">&lt;/<span class="name">em</span>&gt;</span></div><div class="line">  <span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>我们在第一行使用了<code>layout.html</code>模板，扩展了基础模板，用于显示信息。for遍历了我们通过<code>render_template()</code>函数所有传递信息。模板也指明了method为post提交数据。</p>
<h4 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h4><figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> "layout.html" %&#125;</span><span class="xml"></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> body %&#125;</span><span class="xml"></span></div><div class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">  <span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> error %&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">error</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>Error:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> </span><span class="template-variable">&#123;&#123; error &#125;&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></div><div class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"</span></span><span class="template-variable">&#123;&#123; url_for('login') &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">method</span>=<span class="string">post</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Username:</div><div class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">name</span>=<span class="string">username</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Password:</div><div class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">password</span> <span class="attr">name</span>=<span class="string">password</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">Login</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="添加样式"><a href="#添加样式" class="headerlink" title="添加样式"></a>添加样式</h3><p>现在数据库连接有了，视图也有了，然后模板也有了，最后就差样式了，我们来添加一下样式，保存为<code>style.css</code>保存在<code>static</code>文件夹中<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">body</span>            &#123; <span class="attribute">font-family</span>: sans-serif; <span class="attribute">background</span>: <span class="number">#eee</span>; &#125;</div><div class="line"><span class="selector-tag">a</span>, <span class="selector-tag">h1</span>, <span class="selector-tag">h2</span>       &#123; <span class="attribute">color</span>: <span class="number">#377ba8</span>; &#125;</div><div class="line"><span class="selector-tag">h1</span>, <span class="selector-tag">h2</span>          &#123; <span class="attribute">font-family</span>: <span class="string">'Georgia'</span>, serif; <span class="attribute">margin</span>: <span class="number">0</span>; &#125;</div><div class="line"><span class="selector-tag">h1</span>              &#123; <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#eee</span>; &#125;</div><div class="line"><span class="selector-tag">h2</span>              &#123; <span class="attribute">font-size</span>: <span class="number">1.2em</span>; &#125;</div><div class="line"></div><div class="line"><span class="selector-class">.page</span>           &#123; <span class="attribute">margin</span>: <span class="number">2em</span> auto; <span class="attribute">width</span>: <span class="number">35em</span>; <span class="attribute">border</span>: <span class="number">5px</span> solid <span class="number">#ccc</span>;</div><div class="line">                  <span class="attribute">padding</span>: <span class="number">0.8em</span>; <span class="attribute">background</span>: white; &#125;</div><div class="line"><span class="selector-class">.entries</span>        &#123; <span class="attribute">list-style</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &#125;</div><div class="line"><span class="selector-class">.entries</span> <span class="selector-tag">li</span>     &#123; <span class="attribute">margin</span>: <span class="number">0.8em</span> <span class="number">1.2em</span>; &#125;</div><div class="line"><span class="selector-class">.entries</span> <span class="selector-tag">li</span> <span class="selector-tag">h2</span>  &#123; <span class="attribute">margin-left</span>: -<span class="number">1em</span>; &#125;</div><div class="line"><span class="selector-class">.add-entry</span>      &#123; <span class="attribute">font-size</span>: <span class="number">0.9em</span>; <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#ccc</span>; &#125;</div><div class="line"><span class="selector-class">.add-entry</span> <span class="selector-tag">dl</span>   &#123; <span class="attribute">font-weight</span>: bold; &#125;</div><div class="line"><span class="selector-class">.metanav</span>        &#123; <span class="attribute">text-align</span>: right; <span class="attribute">font-size</span>: <span class="number">0.8em</span>; <span class="attribute">padding</span>: <span class="number">0.3em</span>;</div><div class="line">                  <span class="attribute">margin-bottom</span>: <span class="number">1em</span>; <span class="attribute">background</span>: <span class="number">#fafafa</span>; &#125;</div><div class="line"><span class="selector-class">.flash</span>          &#123; <span class="attribute">background</span>: <span class="number">#cee5F5</span>; <span class="attribute">padding</span>: <span class="number">0.5em</span>;</div><div class="line">                  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#aacbe2</span>; &#125;</div><div class="line"><span class="selector-class">.error</span>          &#123; <span class="attribute">background</span>: <span class="number">#f0d6d6</span>; <span class="attribute">padding</span>: <span class="number">0.5em</span>; &#125;</div></pre></td></tr></table></figure></p>
<h3 id="测试Flask"><a href="#测试Flask" class="headerlink" title="测试Flask"></a>测试Flask</h3><p>这个必须介绍一下，因为写代码的过程中免不了要调试和测试，现在讲一下怎么用<code>unittest</code>包来测试flask应用</p>
<h4 id="测试骨架"><a href="#测试骨架" class="headerlink" title="测试骨架"></a>测试骨架</h4><p>为了测试我们的应用，我们添加一个新的模块<code>flaskr_tests.py</code>:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> flaskr</div><div class="line"><span class="keyword">import</span> unittest</div><div class="line"><span class="keyword">import</span> tempfile</div><div class="line"><span class="class"></span></div><div class="line"><span class="keyword">class</span> <span class="type">FlaskrTestCase</span>(<span class="title">unittest</span>.<span class="type">TestCase</span>):</div><div class="line"></div><div class="line">    def setUp(<span class="title">self</span>):</div><div class="line">        self.db_fd, flaskr.app.config['<span class="type">DATABASE'</span>] = tempfile.mkstemp()</div><div class="line">        flaskr.app.config['<span class="type">TESTING'</span>] = <span class="type">True</span></div><div class="line">        self.app = flaskr.app.test_client()</div><div class="line">        flaskr.init_db()</div><div class="line"></div><div class="line">    def tearDown(<span class="title">self</span>):</div><div class="line">        os.close(<span class="title">self</span>.<span class="title">db_fd</span>)</div><div class="line">        os.unlink(<span class="title">flaskr</span>.<span class="title">app</span>.<span class="title">config</span>['<span class="type">DATABASE</span>'])</div><div class="line"></div><div class="line">if __name__ == '__main__':</div><div class="line">    unittest.main()</div></pre></td></tr></table></figure></p>
<p>稍微介绍一下这个测试是个啥意思:</p>
<ol>
<li><code>setUp()</code>方法中会创建一个新的测试客户端并出书画了一个连接，每一个独立的测试函数运行之前都要调用这个函数</li>
<li><code>tearDown()</code>功能是在测试结束以后关闭文件，并在文件中删除数据库库文件，另外<code>TESTING=True</code>,这意味着在请求时关闭错误捕捉，这样可以真实的捕捉到错误，得到更好的错误报告。</li>
</ol>
<p>测试客户端会提供一个简单的应用接口，我们通过这个接口向应用发送测试请求，还可以追踪cookies。<br>因为<code>sqlite3</code>是一个文件系统数据库，所以可以使用临时文件来创建一个临时数据库并初始化它。<code>mkstemp()</code>函数返回两个东西:一个低级别的文件句柄和一个随机文件名,这个文件名将会作为我们的数据库名称。必须把句柄保存到<code>self.db_fd</code>种，这样在整个测试类里面才能在其他方法中来关闭文件。<br>可以在终端中运行测试程序，如果没有报错，才说明没有语法错误：<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(<span class="keyword">env</span>)➜  flasker  <span class="keyword">python</span> flaskr_tests.py </div><div class="line"></div><div class="line">----------------------------------------------------------------------</div><div class="line">Ran <span class="number">0</span> tests <span class="keyword">in</span> <span class="number">0.000</span>s</div><div class="line"></div><div class="line">OK</div></pre></td></tr></table></figure></p>
<h4 id="第一个测试"><a href="#第一个测试" class="headerlink" title="第一个测试"></a>第一个测试</h4><p>Web应用就是测试一些URL访问是否正常，添加一个访问URL(/)的方法：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlaskrTestCase</span>(<span class="title">unittest</span>.<span class="title">TestCase</span>):</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">        <span class="keyword">self</span>.db_fd, flaskr.app.config[<span class="string">'DATABASE'</span>] = tempfile.mkstemp()</div><div class="line">        <span class="keyword">self</span>.app = flaskr.app.test_client()</div><div class="line">        flaskr.init_db()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDown</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">        os.close(<span class="keyword">self</span>.db_fd)</div><div class="line">        os.unlink(flaskr.app.config[<span class="string">'DATABASE'</span>])</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_empty_db</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">        rv = <span class="keyword">self</span>.app.get(<span class="string">'/'</span>)</div><div class="line">        assert <span class="string">'No entries here so far'</span> <span class="keyword">in</span> rv.data</div></pre></td></tr></table></figure></p>
<p><strong>注意:</strong>测试的函数都是以<code>test</code>开始的，这样<code>unittest</code>就会自动识别这些用于测试的函数并运行它们。通过使用<code>self.app.get()</code>可以给制定的URL发送<strong>HTTP GET</strong>请求，其返回的是一个<code>～flask.Flask.reponse_class</code>对象，通过检查其data属性来检测其返回值</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Flask/">Flask</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Python/">Python</a><a href="/tags/Web/">Web</a><a href="/tags/Flask/">Flask</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/24/Flask-学习笔记01/" title="Flask 学习笔记01 " itemprop="url">Flask 学习笔记01 </a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-04-24T10:56:39.000Z" itemprop="datePublished"> 发表于 2016-04-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>由于平时经常使用Python,所以想使用Python的微框架开发一些简单的工具来提升工作效率，特此记录一下学习Flask的笔记。</p>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>本机系统: Ubuntu 14.04 64bits<br>所有的学习第一步就是配置开发环境，还好Ubuntu自带了Python,这里采用的虚拟Python配置，<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-<span class="built_in">get</span> install <span class="keyword">python</span>-virtualenv</div></pre></td></tr></table></figure></p>
<p>或者使用pip安装:<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span><span class="variable">$ </span>sudo pip install virtualenv</div></pre></td></tr></table></figure></p>
<p>如果你是Windows用户，并且你已经安装了<code>pip</code>工具，则去掉<code>sudo</code>在cmd命令下也可以安装<br>然后创建一个包含<code>venv</code>的文件夹的项目文件夹，项目就建在这里面<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>sudo mkdir flask_project</div><div class="line"><span class="variable">$ </span>cd flask_project</div><div class="line"><span class="variable">$ </span>sudo virtualenv venv</div></pre></td></tr></table></figure></p>
<p>现在每次要使用项目，就可以在<code>flask_project</code>文件夹中运行下面的命令<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ . venv/bin/<span class="built_in">activate</span></div></pre></td></tr></table></figure></p>
<p>对应的Windows启动命令为<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ . venv/Scripts/<span class="built_in">activate</span></div></pre></td></tr></table></figure></p>
<p>你现在进入你的virtualenv(注意查看你的shell提示符已经改变了)。每次需要安装包的时候就先激活虚拟环境，下面安装<code>flask</code><br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip <span class="keyword">install</span> flask</div></pre></td></tr></table></figure></p>
<p><strong>注意:</strong>这里有个地方需要个别强调一下，安装包不能使用sudo权限来安装，如果不带<code>sudo</code>安装提示权限不够，请把<code>flask_project</code>文件夹的权限设置为当前用户,例如，当前用户为<code>zhangsan</code>,在<code>flask_project</code>的父目录执行:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">chown</span> <span class="selector-tag">zhangsan</span><span class="selector-pseudo">:zhangsan</span> <span class="selector-tag">-R</span> <span class="selector-tag">flask_project</span></div></pre></td></tr></table></figure></p>
<p>相应的退出使用:<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>deactivate</div></pre></td></tr></table></figure></p>
<h3 id="一个最简单的应用"><a href="#一个最简单的应用" class="headerlink" title="一个最简单的应用"></a>一个最简单的应用</h3><p>在<code>flask_project</code>文件夹中创建一个文件<code>hello.py</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    app.run()</div></pre></td></tr></table></figure></p>
<p>在命令行或者终端里运行:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">python</span> hello.<span class="keyword">py</span></div></pre></td></tr></table></figure></p>
<p>然后在浏览器打开<code>http://127.0.0.1:5000/</code>就可以看到一个最简单的hello world页面了。大概解释一下：</p>
<ol>
<li>首先我们导入了<strong>Flask</strong>类。这个类的实例将会成为我们的<strong>WSGI</strong>应用,即后面的<strong>app</strong>。</li>
<li>接着我们创建了这个类的实例。第一个参数是应用模块或者包的名称。如果你使用一个 单一模块（就像本例），那么应当使用<code>__name__</code>,因为名称会根据这个模块是按 应用方式使用还是作为一个模块导入而发生变化（可能是<code>__main__</code>，也可能是 实际导入的名称）。这个参数是必需的，这样<strong>Flask</strong>就可以知道在哪里找到模板和 静态文件等东西。不明白也没关系，先这么写，后面慢慢会深入研究。</li>
<li>然后我们使用<code>route()</code>装饰器来告诉<strong>Flask</strong>触发函数的<strong>URL</strong>。函数名称可用于生成相关联的<strong>URL</strong>，并返回需要在用户浏览器中显示的信息。这个和Java里的<strong>Controller</strong>非常的像，用过Spring的同学对此应该很熟悉。</li>
<li>最后，使用<code>run()</code>函数来运行本地服务器和我们的应用。<code>if __name__ == &#39;__main__&#39;:</code> 确保服务器只会在使用Python解释器运行代码的情况下运行，而不会在作为模块导入时运行。</li>
</ol>
<p>本机访问没问题，但是局域网的其他机器如果也想访问，则需要这样启动:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.run(host='<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>')</div></pre></td></tr></table></figure></p>
<p>这行代码告诉你的操作系统监听一个公开的IP 。</p>
<h3 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h3><p>开发程序不可能这么简单，需要不断的调试，所以<strong>Flask</strong>也为我们想好了，专门有个调试模式，这样不用重启服务器，代码有变动，会自动重启，并且出错提示信息也很强大，打开调试器的有两种方式：</p>
<ol>
<li><p>通过设置实例的属性</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">app</span>.debug = True</div><div class="line"><span class="keyword">app</span>.<span class="keyword">run</span>()</div></pre></td></tr></table></figure>
</li>
<li><p>启动传参设置</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.<span class="built_in">run</span>(debug=<span class="literal">True</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>注意:</strong>调试器很强大，可以执行任意代码，所以千万不要在项目上线之后打开调试模式。</p>
<h3 id="路由route"><a href="#路由route" class="headerlink" title="路由route()"></a>路由route()</h3><p>路由装饰器用于将一个函数和一个<strong>URL</strong>绑定，例如:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@app</span>.route(<span class="string">'/'</span>)</div><div class="line">def index():</div><div class="line">    return <span class="string">'Index Page'</span></div><div class="line"></div><div class="line"><span class="variable">@app</span>.route(<span class="string">'/hello'</span>)</div><div class="line">def hello():</div><div class="line">    return <span class="string">'Hello World'</span></div></pre></td></tr></table></figure></p>
<p>这只是最简单，最基础的，实际开发中不可能都是这么简单的URL,大多数情况下URL里面有一部分是动态变化的，例如好多URL里面会带ID,表示网页的一个标号。</p>
<h4 id="变量规则"><a href="#变量规则" class="headerlink" title="变量规则"></a>变量规则</h4><p><variable_name>里面可以添加变量，<converter:variable_name>可以为变量加一个转换器,目前只支持<code>int,float,path</code>最后一个为路径，接受<code>/</code>，例如：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/user/&lt;username&gt;'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_user_profile</span><span class="params">(username)</span></span>:</div><div class="line">    <span class="comment"># 通过获取URL的user_name作为函数的传入参数</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'User %s'</span> % username</div><div class="line"></div><div class="line">@app.route(<span class="string">'/post/&lt;int:post_id&gt;'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_post</span><span class="params">(post_id)</span></span>:</div><div class="line">    <span class="comment"># 传入post_id，并且必须是一个整数</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Post %d'</span> % post_id</div></pre></td></tr></table></figure></converter:variable_name></variable_name></p>
<h4 id="唯一URL-重定向问题"><a href="#唯一URL-重定向问题" class="headerlink" title="唯一URL/重定向问题"></a>唯一URL/重定向问题</h4><p>看下面一个例子:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@app</span>.route(<span class="string">'/projects/'</span>)</div><div class="line">def projects():</div><div class="line">    return <span class="string">'The project page'</span></div><div class="line"></div><div class="line"><span class="variable">@app</span>.route(<span class="string">'/about'</span>)</div><div class="line">def about():</div><div class="line">    return <span class="string">'The about page'</span></div></pre></td></tr></table></figure></p>
<p>注意一个尾部有<strong>斜杠</strong>，一个没有。看上去带<strong>斜杠</strong>的URL很像一个文件夹，当我们访问一个没有带<strong>斜杠</strong>的URL的时候，为自动加一个<strong>斜杠</strong>。但是反过来，如果访问第二个URL你在尾部带了一个<strong>斜杠</strong>，则会报错。可能你有些疑惑，为啥要这么做，答案也很简单：这样在访问一个不带<strong>斜杠</strong>的URL时，不管真正的URL是否带<strong>斜杠</strong>我们都可以继续访问URL,并且URL是唯一的。</p>
<h4 id="URL构建"><a href="#URL构建" class="headerlink" title="URL构建"></a>URL构建</h4><p>设想一下，你想先设定好页面的访问URL,你需要测试你写的函数能不能被你指定的URL访问到，直接构建这些URL就可以了。<code>url_for</code>它把函数名称作为第一个参数，其余参数对应URL中的变量。未知变量将添加到URL中作为查询参数。 例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, url_for</div><div class="line">app = Flask(__name__)</div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span> <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/login')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span> <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/user/&lt;username&gt;')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">profile</span><span class="params">(username)</span>:</span> <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="keyword">with</span> app.test_request_context():</div><div class="line">	<span class="keyword">print</span> url_for(<span class="string">'index'</span>)</div><div class="line">	<span class="keyword">print</span> url_for(<span class="string">'login'</span>)</div><div class="line">	<span class="keyword">print</span> url_for(<span class="string">'login'</span>, next=<span class="string">'/'</span>)</div><div class="line">	<span class="keyword">print</span> url_for(<span class="string">'profile'</span>, username=<span class="string">'John Doe'</span>)</div></pre></td></tr></table></figure></p>
<p>运行程序会输出以下内容:<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/</div><div class="line"><span class="regexp">/login</span></div><div class="line">/login?<span class="keyword">next</span>=<span class="regexp">/</span></div><div class="line">/user<span class="regexp">/John%20Doe</span></div></pre></td></tr></table></figure></p>
<p>这里用到了一个方法<code>test_request_context()</code>,这个会告诉<code>Flask</code>我们正在处理一个请求，虽然我们并没有真正的去请一个URL.</p>
<h4 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h4><p>访问一个URL有好几个方法，常见的就是get，post方法,缺省情况下一个路由只回应GET请求，也可以像下面这样手动指定：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/login'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span></span>:</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        do_the_login()</div><div class="line">    <span class="symbol">else:</span></div><div class="line">        show_the_login_form()</div></pre></td></tr></table></figure></p>
<h4 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h4><p>一般就是指css,js文件，如果工程里面要用到这些静态的库，可以在应用的根目录下新建<code>static</code>文件夹,设用选定的<code>static</code>端点就可以生成对应的URL：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">url_for</span><span class="params">(<span class="string">'static'</span>, filename=<span class="string">'style.css'</span>)</span></span></div></pre></td></tr></table></figure></p>
<p>因此该文件对应的在文件系统中的路径应该是<code>static/style.css</code></p>
<h4 id="渲染模板"><a href="#渲染模板" class="headerlink" title="渲染模板"></a>渲染模板</h4><p>这是个很强大的功能，基本上目前的框架都得支持这个，毕竟原生的写HTML很慢，还要考虑各种转义，乱码等，Flask内置Jinja2模板引擎。使用<code>render_template()</code>来渲染模板,只需要把模板的名字和对应的一些参数传进去就行了，例如:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">from flask import render_template</div><div class="line"></div><div class="line">@app.route(<span class="string">'/hello/'</span>)</div><div class="line">@app.route(<span class="string">'/hello/&lt;name&gt;'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name=None)</span></span>:</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'hello.html'</span>, name=name)</div></pre></td></tr></table></figure></p>
<p>Flask默认会在<code>templates</code>文件夹内寻找模板，如果你的应用是一个模块,则<code>templates</code>文件夹应该和应用在一个目录下,即:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/application<span class="selector-class">.py</span></div><div class="line">/templates</div><div class="line">    /hello.html</div></pre></td></tr></table></figure></p>
<p>如果你的应用是一个包,则应该在包里面:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/application</div><div class="line">    /__init__<span class="selector-class">.py</span></div><div class="line">    /templates</div><div class="line">        /hello.html</div></pre></td></tr></table></figure></p>
<p>这个就类似预JSP一类的东西，你也可以在模板内部访问**request, session, get_flashed_messages()<code>等，不过比JSP更加强大,因为模板可以实现继承，这样就能保持很多特定的元素重用，保持一致。
默认特殊的一些变量会被转义，例如HTML,如果信任某个变量，也可以使用</code>Markup`类来把它标记为安全的,具体的等学到了再详细研究。</p>
<h3 id="操作请求数据"><a href="#操作请求数据" class="headerlink" title="操作请求数据"></a>操作请求数据</h3><p>一个Web应用其实就是服务器相应客户端发来的消息，Flask中由全局对象<code>request</code>来提供请求信息，如果你熟悉Python你就会知道，全局的对象大家都可以访问，其实也并不是通常意义上的全局变量，这个request只是特定环境下的本地对象的一个代理。</p>
<h4 id="请求对象"><a href="#请求对象" class="headerlink" title="请求对象"></a>请求对象</h4><p>首先必须从flask模块导入请求对象<code>from flask import request</code>,使用<code>method</code>属性可以操作当前请求的具体方法，<code>form</code>可以处理表单数据,例如:<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@app.route(<span class="string">'/login'</span>, methods=[<span class="string">'POST'</span>, <span class="string">'GET'</span>])</div><div class="line">def login():</div><div class="line">    <span class="keyword">error</span> = None</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        <span class="keyword">if</span> valid_login(request.form[<span class="string">'username'</span>],</div><div class="line">                       request.form[<span class="string">'password'</span>]):</div><div class="line">            <span class="keyword">return</span> log_the_user_in(request.form[<span class="string">'username'</span>])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">error</span> = <span class="string">'Invalid username/password'</span></div><div class="line">    # 如果请求访求是 GET 或验证未通过就会执行下面的代码</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, <span class="keyword">error</span>=<span class="keyword">error</span>)</div></pre></td></tr></table></figure></p>
<p>如果form属性中不存在这个键值，会像普通集合那样抛出一个<code>KeyError</code>的异常。如果不捕获的话，就会显示一个<code>HTTP 400 Bad Request</code>错误页面，虽然你可以不用处理这个异常，但是显然不是很友好，所以推荐捕获异常，然会一个预定义好的错误页面.<br>如果要处理URL中的参数，可以使用<code>request.args.get(&#39;key&#39;, &#39;&#39;)</code>来获取.</p>
<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><p>使用Flask实现文件上传很简单，需要在HTML表单中设置<code>enctype=&quot;multipart/form-data</code>属性即可，上传的文件被存储在内存或者文件系统临时位置，通过请求对象files属性可以访问上传文件,看下面的例子：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from flask import request</div><div class="line"></div><div class="line">@app.route(<span class="string">'/upload'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span></span>:</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        f = request.files[<span class="string">'the_file'</span>]</div><div class="line">        f.save(<span class="string">'/var/www/uploads/uploaded_file.txt'</span>)</div></pre></td></tr></table></figure></p>
<p>要想知道文件上传之前在客户端系统的名字，可以使用<code>filename</code>属性，但是这个可以伪造，所以建议通过<code>Werkzeug</code>提供的<code>secure_filename()</code>函数：<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</div><div class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</div><div class="line"></div><div class="line">@app.route(<span class="string">'/upload'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</div><div class="line">def upload_file():</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        f = request.files[<span class="string">'the_file'</span>]</div><div class="line">        f.save(<span class="string">'/var/www/uploads/'</span> + secure_filename(f.filename))</div></pre></td></tr></table></figure></p>
<h4 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h4><p>对于Web应用来说，这个必不可少，要访问cookeis,可以使用<code>cookies</code>属性。通过请求对象的<code>set_cookies</code>方法设置<code>cookies</code>，请求对象的<code>cookies</code>包含了客户端的所有cookies字典，所以这很不安全，能使用会话就不要直接使用cookies.</p>
<ul>
<li><p>读cookies:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    username = request.cookies.get(<span class="string">'username'</span>)</div><div class="line">    <span class="comment"># 使用 cookies.get(key) 来代替 cookies[key] ，</span></div><div class="line">    <span class="comment"># 以避免当 cookie 不存在时引发 KeyError 。</span></div></pre></td></tr></table></figure>
</li>
<li><p>存储cookies:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    resp = make_response(render_template(...))</div><div class="line">    resp.set_cookie(<span class="string">'username'</span>, <span class="string">'the username'</span>)</div><div class="line">    <span class="keyword">return</span> resp</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>注意:</strong>cookies设置在响应对象上，通常只是视图函数返回字符串，Flask会把它们转化为响应对象,显示的转化可以使用<code>make_response()</code>函数,然后再修改对应的值.</p>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p><code>redirect()</code>函数可以重定向,<code>abort()</code>可以更早的退出请求，返回错误码:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">from flask import abort, redirect, url_for</div><div class="line"></div><div class="line">@app.route(<span class="string">'/'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span></span>:</div><div class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</div><div class="line"></div><div class="line">@app.route(<span class="string">'/login'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span></span>:</div><div class="line">    abort(<span class="number">401</span>)</div><div class="line">    this_is_never_executed()</div></pre></td></tr></table></figure></p>
<p><code>401</code>表示一个无法访问的页面,缺省情况下每种错误代码都会对应显示一个黑白的出错页面。使用<code>errorhandler()</code>装饰器可以定制出错页面:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</div><div class="line"></div><div class="line"><span class="meta">@app.errorhandler(404)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(error)</span>:</span></div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'page_not_found.html'</span>), <span class="number">404</span></div></pre></td></tr></table></figure></p>
<h4 id="关于响应"><a href="#关于响应" class="headerlink" title="关于响应"></a>关于响应</h4><p>视图函数的返回值会自动转化为一个响应对象。如果你返回一个字符串，那么就会被转换为一个响应对象，其中包含这个字符串以及一些其他的必要信息，如果想在视图内部掌控响应对象的结果，可以使用一个<code>make_response()</code>函数进行强制转换，例如原始视图:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@app.errorhandler(<span class="number">404</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span><span class="params">(error)</span></span>:</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'error.html'</span>), <span class="number">404</span></div></pre></td></tr></table></figure></p>
<p>可以手动包装，修改某些特定的内容，例如头部信息：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@app.errorhandler(<span class="number">404</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span><span class="params">(error)</span></span>:</div><div class="line">    resp = make_response(render_template(<span class="string">'error.html'</span>), <span class="number">404</span>)</div><div class="line">    resp.headers[<span class="string">'X-Something'</span>] = <span class="string">'A value'</span></div><div class="line">    <span class="keyword">return</span> resp</div></pre></td></tr></table></figure></p>
<h4 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h4><p>除了请求对象和响应对象之外，还有个<code>session</code>这个对象，这个主要是用来在不同请求之间存储信息的。你可以简单理解为用密钥签名加密的cookie,cookie都可以查看，但是如果没有密钥就无法修改。所以使用会话之前必须设置一个密钥：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, redirect, url_for, escape, request</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> session:</div><div class="line">        <span class="keyword">return</span> <span class="string">'Logged in as %s'</span> % escape(session[<span class="string">'username'</span>])</div><div class="line">    <span class="keyword">return</span> <span class="string">'You are not logged in'</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/login', methods=['GET', 'POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        session[<span class="string">'username'</span>] = request.form[<span class="string">'username'</span>]</div><div class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</div><div class="line">    <span class="keyword">return</span> <span class="string">'''</span></div><div class="line">        &lt;form action="" method="post"&gt;</div><div class="line">            &lt;p&gt;&lt;input type=text name=username&gt;</div><div class="line">            &lt;p&gt;&lt;input type=submit value=Login&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">    '''</div><div class="line"></div><div class="line"><span class="meta">@app.route('/logout')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># 如果会话中有用户名就删除它。</span></div><div class="line">    session.pop(<span class="string">'username'</span>, <span class="keyword">None</span>)</div><div class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</div><div class="line"></div><div class="line"><span class="comment"># 设置密钥，复杂一点：</span></div><div class="line">app.secret_key = <span class="string">'A0Zr98j/3yX R~XHH!jmN]LWX/,?RT'</span></div></pre></td></tr></table></figure></p>
<p><code>escape()</code>可以用来转义，如果你使用模板就简单的多，不用管这些。<br>生成密钥要保证做够随机,例如根据操作系统来生成一个密钥:<br><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="built_in">os</span></div><div class="line"><span class="built_in">os</span>.urandom(<span class="number">24</span>)</div></pre></td></tr></table></figure></p>
<p>基于<code>cookies</code>的会话，Flask其实是把会话对象里面的值都放在了cookies里面，如果你访问的会话里没有对应的属性。</p>
<h4 id="消息闪现"><a href="#消息闪现" class="headerlink" title="消息闪现"></a>消息闪现</h4><p>啥意思？简单来说就是在你请求结束的时候记录一个消息，然后你下次再请求的时候可以使用，然后用完就销毁了，所以叫闪现。<code>flash()</code>用于闪现一个消息，<code>get_flashed_messages()</code>来操作一个消息，具体的不介绍了，这个用的不是很多，用到再研究。</p>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>一个Web应用当然少不了日志，万一崩了，直接看日志定位问题，使用也很简单:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app<span class="selector-class">.logger</span><span class="selector-class">.debug</span>(<span class="string">'A value for debugging'</span>)</div><div class="line">app<span class="selector-class">.logger</span><span class="selector-class">.warning</span>(<span class="string">'A warning occurred (%d apples)'</span>, <span class="number">42</span>)</div><div class="line">app<span class="selector-class">.logger</span><span class="selector-class">.error</span>(<span class="string">'An error occurred'</span>)</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Flask/">Flask</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Python/">Python</a><a href="/tags/Web/">Web</a><a href="/tags/Flask/">Flask</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/24/Python-写csv文件Excel打开乱码解决方案/" title="Python 写csv文件Excel打开乱码解决方案" itemprop="url">Python 写csv文件Excel打开乱码解决方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-04-24T10:37:32.000Z" itemprop="datePublished"> 发表于 2016-04-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h3><p>最近为公司开发了一套邮件日报程序，邮件一般就是表格，图片，然后就是附件。附件一般都是默认写到txt文件里，但是PM希望邮件里的附件能直接用Excel这种软件打开，最开始想保存为Excel，但是一想Excel的文件体积会多出好多倍，csv文件默认也是使用Excel打开的，但是根本还是文本文件，体积小，保存也方便，于是最终决定使用csv模块来保存文件。</p>
<h3 id="Python写csv文件"><a href="#Python写csv文件" class="headerlink" title="Python写csv文件"></a>Python写csv文件</h3><p>Python提供了内置模块读写csv文件，这里我只用到了写，读这里就不做介绍了，也不难,主要是解决乱码问题。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">save2csv</span><span class="params">(file_name=None, header=None, data=None)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    保存成CSV格式文件,方便Excel直接打开</div><div class="line">    :param file_name: 保存的文件名</div><div class="line">    :param header: 表头,每一列的名字</div><div class="line">    :param data: 具体填充数据</div><div class="line">    :return:</div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> file_name <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> isinstance(file_name, basestring) <span class="keyword">is</span> <span class="keyword">False</span>:</div><div class="line">        <span class="keyword">raise</span> Exception(<span class="string">'保存CSV文件名不能为空,并且必须为字符串类型'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> file_name.endswith(<span class="string">'.csv'</span>) <span class="keyword">is</span> <span class="keyword">False</span>:</div><div class="line">        file_name += <span class="string">'.csv'</span></div><div class="line"></div><div class="line">    file_obj = open(file_name, <span class="string">'wb'</span>)</div><div class="line">    file_obj.write(codecs.BOM_UTF8)     <span class="comment"># 防止乱码</span></div><div class="line">    writer = csv.writer(file_obj)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> isinstance(data, (tuple, list)) <span class="keyword">is</span> <span class="keyword">False</span>:</div><div class="line">        <span class="keyword">raise</span> Exception(<span class="string">'保存CSV文件失败,数据为空或者不是数据类型'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> header <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> isinstance(header, (tuple, list)) <span class="keyword">is</span> <span class="keyword">True</span>:</div><div class="line">        writer.writerow(header)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data:</div><div class="line">        writer.writerow(row)</div></pre></td></tr></table></figure></p>
<p><strong>注意:</strong>有三句话就是为了防止乱码的<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">file_obj = <span class="keyword">open</span>(file_name, 'wb')</div><div class="line">file_obj.write(codecs.BOM_UTF8)     <span class="meta"># 防止乱码</span></div><div class="line"><span class="built_in">writer</span> = csv.<span class="built_in">writer</span>(file_obj)</div></pre></td></tr></table></figure></p>
<p>在文件头部写入<code>codecs.BOM_UTF8</code>就能防止乱码了,文件都是utf-8编码格式的。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Python笔记/">Python笔记</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/24/Hive-group-by-distinct性能调优/" title="Hive group by distinct性能调优" itemprop="url">Hive group by distinct性能调优</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="LittleQ" target="_blank" itemprop="author">LittleQ</a>
		
  <p class="article-time">
    <time datetime="2016-04-24T09:51:15.000Z" itemprop="datePublished"> 发表于 2016-04-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="Hive去重统计"><a href="#Hive去重统计" class="headerlink" title="Hive去重统计"></a>Hive去重统计</h3><p>相信使用Hive的人平时会经常用到去重统计之类的吧，但是好像平时很少关注这个去重的性能问题，但是当一个表的数据量非常大的时候，会发现一个简单的<code>count(distinct order_no)</code>这种语句跑的特别慢，和直接运行<code>count(order_no)</code>的时间差了很多，于是研究了一下。<br><strong>先说结论:</strong>能使用<code>group by</code>代替<code>distinc</code>就不要使用<code>distinct</code>，例子：</p>
<h3 id="实际论证"><a href="#实际论证" class="headerlink" title="实际论证"></a>实际论证</h3><p>order_snap为订单的快照表 总记录条数763191489，即将近8亿条记录,总大小:108.877GB,存储的是公司所有的订单信息，表的字段大概有20个,其中订单号是没有重复的,所以在统计总共有多少订单号的时候去重不去重结果都一样，我们来看看:<br>统计所有的订单有多少条条数，一个<code>count</code>函数就可以搞定的sql性能如何。</p>
<ul>
<li>DISTINCT</li>
</ul>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">select count(distinct order_no) from order_snap;</div><div class="line">Stage-Stage-1: Map:<span class="number"> 396 </span> Reduce:<span class="number"> 1 </span>  Cumulative CPU: 7915.67 sec   HDFS Read:<span class="number"> 119072894175 </span>HDFS Write:<span class="number"> 10 </span>SUCCESS</div><div class="line">Total MapReduce CPU Time Spent:<span class="number"> 0 </span>days<span class="number"> 2 </span>hours<span class="number"> 11 </span>minutes<span class="number"> 55 </span>seconds<span class="number"> 670 </span>msec</div><div class="line"><span class="symbol">OK</span></div><div class="line">_c0</div><div class="line">763191489</div><div class="line">Time taken: 1818.864 seconds, Fetched:<span class="number"> 1 </span>row(s)</div></pre></td></tr></table></figure>
<ul>
<li>GROUP BY</li>
</ul>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">select count(t.order_no) from (select order_no from order_snap group by order_no) t;</div><div class="line">Stage-Stage-1: Map:<span class="number"> 396 </span> Reduce:<span class="number"> 457 </span>  Cumulative CPU: 10056.7 sec   HDFS Read:<span class="number"> 119074266583 </span>HDFS Write:<span class="number"> 53469 </span>SUCCESS</div><div class="line">Stage-Stage-2: Map:<span class="number"> 177 </span> Reduce:<span class="number"> 1 </span>  Cumulative CPU: 280.22 sec   HDFS Read:<span class="number"> 472596 </span>HDFS Write:<span class="number"> 10 </span>SUCCESS</div><div class="line">Total MapReduce CPU Time Spent:<span class="number"> 0 </span>days<span class="number"> 2 </span>hours<span class="number"> 52 </span>minutes<span class="number"> 16 </span>seconds<span class="number"> 920 </span>msec</div><div class="line"><span class="symbol">OK</span></div><div class="line">_c0</div><div class="line">763191489</div><div class="line">Time taken: 244.192 seconds, Fetched:<span class="number"> 1 </span>row(s)</div></pre></td></tr></table></figure>
<p><strong>结论:</strong>第二种写法的性能是第一种的<code>7.448499541</code>倍<br>注意到为什么会有这个差异，Hadoop其实就是处理大数据的，Hive并不怕数据有多大，怕的就是数据倾斜,我们看看两者的输出信息:<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># distinct</span></div><div class="line">Stage-Stage-1: Map:<span class="number"> 396 </span> Reduce:<span class="number"> 1 </span>  Cumulative CPU: 7915.67 sec   HDFS Read:<span class="number"> 119072894175 </span>HDFS Write:<span class="number"> 10 </span>SUCCESS</div><div class="line"><span class="comment"># group by</span></div><div class="line">Stage-Stage-1: Map:<span class="number"> 396 </span> Reduce:<span class="number"> 457 </span>  Cumulative CPU: 10056.7 sec   HDFS Read:<span class="number"> 119074266583 </span>HDFS Write:<span class="number"> 53469 </span>SUCCESS</div></pre></td></tr></table></figure></p>
<p>发现猫腻了没有，使用distinct会将所有的order_no都shuffle到一个reducer里面，这就是我们所说的数据倾斜，都倾斜到一个reducer这样性能能不低么？再看第二个，直接按订单号分组，起了457个<code>reducer</code>，将数据分布到多台机器上执行，时间当然快了.<br>由于没有手动指定Reduce的个数，Hive会根据数据的大小动态的指定Reduce大小，你也可以手动指定<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive&gt; set mapred<span class="selector-class">.reduce</span><span class="selector-class">.tasks</span>=<span class="number">100</span>；</div></pre></td></tr></table></figure></p>
<p>类似这样,所以如果数据量特别大的情况下，尽量不要使用<code>distinct</code>吧。<br>但是如果你想在一条语句里看总记录条数以及去重之后的记录条数，那没有办法过滤，所以你有两个选择，要么使用两个sql语句分别跑，然后union all或者就使用普通的distinct。具体来说得看具体情况，直接使用distinct可读性好，数据量如果不大的话推荐使用，如果数据太大了，性能受到影响了，再考虑优化。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Hive笔记/">Hive笔记</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Hive/">Hive</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/5/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Django/" title="Django">Django<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Flask/" title="Flask">Flask<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Git/" title="Git">Git<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hive笔记/" title="Hive笔记">Hive笔记<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/JScript/" title="JScript">JScript<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java笔记/" title="Java笔记">Java笔记<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux使用/" title="Linux使用">Linux使用<sup>23</sup></a></li>
		  
		
		  
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python笔记/" title="Python笔记">Python笔记<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/Shell/" title="Shell">Shell<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Vim/" title="Vim">Vim<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客搭建/" title="博客搭建">博客搭建<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/开发环境/" title="开发环境">开发环境<sup>22</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据挖掘/" title="数据挖掘">数据挖掘<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂七杂八/" title="杂七杂八">杂七杂八<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>41</sup></a></li>
			
		
			
				<li><a href="/tags/开发工具/" title="开发工具">开发工具<sup>19</sup></a></li>
			
		
			
				<li><a href="/tags/SQL/" title="SQL">SQL<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hive/" title="Hive">Hive<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Shell/" title="Shell">Shell<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/Web/" title="Web">Web<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/开发环境/" title="开发环境">开发环境<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Git/" title="Git">Git<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Vim/" title="Vim">Vim<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/大数据/" title="大数据">大数据<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Flask/" title="Flask">Flask<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/IDEA/" title="IDEA">IDEA<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Js/" title="Js">Js<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/可视化/" title="可视化">可视化<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/JS/" title="JS">JS<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Sublime-Text/" title="Sublime Text">Sublime Text<sup>2</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="LittleQ">LittleQ</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
